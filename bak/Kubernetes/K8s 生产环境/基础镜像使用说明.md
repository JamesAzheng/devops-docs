# 系统基础镜像

## 基础镜像说明

### 拉取指令

- **centos7：**
  
  - ```
    docker pull 172.16.0.120:30002/system/centos7@sha256:9a2b137a3d61d70ce9e9c9be4e867536133003fd60a357bbd06daf5da24ef6eb
    ```
- **Ubuntu16.04：**
  - ```sh
    docker pull 172.16.0.120:30002/system/ubuntu1604@sha256:43d4baaa7c2f1bb045ee4d551bd04ca780af47c05ca9e1e085bec724609d0d62
    ```
- **Ubuntu18.04：**
  - ...

### 包含的工具

- 为减少基础镜像的大小，仅了安装一些常用工具，以提高镜像的加载速度和降低磁盘空间使用率等。

**网络相关：**

```
ip、ifconfig
ping
ss、netstat
bridge
tcpdump
route、traceroute
arp
nmap
dig、nslookup、host
iftop、nethogs
telnet
```

**其它：**

```
vi
ps、top
wget
等...
```



### 支持的环境变量

- 基础镜像支持通过环境变量传参，可以根据不同应用场景，指向公网/私网的服务器。

| key            | 说明             | default                             | type   |
| -------------- | ---------------- | ----------------------------------- | ------ |
| NTP_SERVER1    | 时间同步服务器一 | ntp.aliyun.com                      | string |
| NTP_SERVER2    | 时间同步服务器二 | ntp1.aliyun.com                     | string |
| MIRRORS_SERVER | yum/apt 镜像源   | /https://mirrors.aliyun.com/ubuntu/ | string |

**MIRRORS_SERVER**

- yum：
  - 清华大学：`MIRRORS_SERVER=mirrors.tuna.tsinghua.edu.cn`
  - 腾讯云：`MIRRORS_SERVER=mirrors.cloud.tencent.com`
  - 公司内部：`MIRRORS_SERVER=172.16.0.137\\:8081\\/repository`
- apt：（Ubuntu1604）
  - 公司内部：`MIRRORS_SERVER=http://172.16.0.137:8081/repository/ubuntu/`
- apt：（Ubuntu1804）
  - 公司内部：`待部署`




#### 范例：指向公司内部的 yum 源

- `MIRRORS_SERVER=172.16.0.137\\:8081\\/repository`

```sh
docker run --name centos7 \
-d \
--rm \
-e "MIRRORS_SERVER=172.16.0.137\\:8081\\/repository" \
172.16.0.120:30002/system/centos7@sha256:9a2b137a3d61d70ce9e9c9be4e867536133003fd60a357bbd06daf5da24ef6eb tail -f /etc/hosts
```



#### 范例：传参前 & 传参后

##### 传参前

```sh
# docker run -d --rm --name centos7 centos7:v1.0

# docker exec -it centos7 bash

[root@d015295f21d7 /]# env | grep -E "NTP_SERVER(1|2)|MIRRORS_SERVER"
NTP_SERVER1=ntp.aliyun.com
NTP_SERVER2=ntp1.aliyun.com
MIRRORS_SERVER=mirrors.aliyun.com

[root@d015295f21d7 /]# cat /etc/yum.repos.d/* | grep -E "^baseurl"
baseurl=http://mirrors.aliyun.com/centos/$releasever/os/$basearch/
...
```

##### 传参后

```sh
# docker run -d --rm --name centos7 -e NTP_SERVER1=s1a.time.edu.cn -e NTP_SERVER2=s1a.time.edu.cn -e MIRRORS_SERVER=mirrors.tuna.tsinghua.edu.cn centos7:v1.0

# docker exec -it centos7 bash

[root@2a28c77813a7 /]# env | grep -E "NTP_SERVER(1|2)|MIRRORS_SERVER"
NTP_SERVER1=s1a.time.edu.cn
NTP_SERVER2=s1a.time.edu.cn
MIRRORS_SERVER=mirrors.tuna.tsinghua.edu.cn


[root@2a28c77813a7 /]# cat /etc/yum.repos.d/* | grep -E "^baseurl"
baseurl=http://mirrors.tuna.tsinghua.edu.cn/centos/$releasever/os/$basearch/
...
```



### 运行基础镜像

基础镜像不包含前台运行的指令，因此直接运行会退出，可以通过添加前台运行命令的方式使其持续运行

**通过 docker run：**

- `docker run -d --rm --name centos7 centos7:v1.0 tail -f /etc/hosts`

**通过 kubernetes yaml：**

- ```yaml
  apiVersion: v1
  kind: Pod
  metadata:
    name: centos7
    namespace: test
  spec:
    containers:
    - name: centos7
      image: centos7:v1.0
      args:
        - /usr/bin/tail
        - -f
        - /etc/hosts
  ...
  ```
  
  





## 基于基础镜像构建业务镜像

- 通过 Dockrfile 构建业务镜像时，只需在 CMD 中添加业务相关的应用程序即可。



### 注意事项

**1：通过 Dockrfile 构建业务镜像时，只能使用 CMD，不能使用 ENTRYPOINT**

- 因为基础镜像的 ENTRYPOINT 中定义了时间同步等初始化策略，如果业务镜像中同样定义了 ENTRYPOINT，则会将基础镜像中的 ENTRYPOINT 覆盖；
- 不过基础镜像的 ENTRYPOINT 中支持自定义传参，在使用时，只需将业务镜像运行的命令或脚本添加到 CMD 即可。

**2：容器运行时，要保证具有前台运行的命令，否则容器启动即退出**

**3：容器运行时，需开启 `CAP_SYS_TIME` 使能才可实现时间同步**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: centos7
  namespace: test
spec:
  containers:
  - name: centos7
    image: centos7:v1.0
    securityContext:
      capabilities:
        add: ['CAP_SYS_TIME'] # 需开启此使能才能完成时间同步
...
```

- 未开启时将产生如下报错

```sh
[root@centos7 /]# /usr/sbin/ntpdate -b ntp.aliyun.com ntp1.aliyun.com
10 Jun 18:06:09 ntpdate[35]: step-systime: Operation not permitted


[root@centos7 /]# tail -f /var/log/time_sync.log
10 Jun 18:06:09 ntpdate[33]: step-systime: Operation not permitted
10 Jun 18:09:08 ntpdate[40]: step-systime: Operation not permitted
10 Jun 18:12:09 ntpdate[43]: step-systime: Operation not permitted
```



### 方法一

- 在 Dockerfile 的 CMD 中指定运行的业务**命令**

#### Dockerfile

```dockerfile
FROM centos7:v1.0
RUN yum makecache && \
    yum install -y \
    nginx \
    && yum clean all
CMD ["/usr/sbin/nginx", "-g", "daemon off;"]
```

- `docker build -t nginx:v1.0 .`

#### yaml

- 直接运行即可

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: test
spec:
  containers:
  - name: nginx
    image: nginx:v1.0
    # 以下变量如未指定则为默认值
    env:
    - name: NTP_SERVER1
      value: "172.16.0.125" # 指向公司内部时间同步服务器1
    - name: NTP_SERVER2
      value: "172.16.0.127" # 指向公司内部时间同步服务器2
    - name: MIRRORS_SERVER 
      value: "mirrors.tuna.tsinghua.edu.cn"
    securityContext:
      capabilities:
        add: ['CAP_SYS_TIME']
  # 运行在master节点用于测试
  nodeSelector:
    kubernetes.io/hostname: 'k8s-master1'
  tolerations:
  - key: node-role.kubernetes.io/master
    effect: NoSchedule
    operator: Exists
```





### 方法二

- 在 Dockerfile 的 CMD 中指定运行的业务**脚本**

#### run_nginx.sh

```sh
#!/bin/bash

# 前台运行nginx
/usr/sbin/nginx -g "daemon off;"
```

- `chmod +x run_nginx.sh `

#### Dockerfile

```dockerfile
FROM centos7:v1.0
RUN yum makecache && \
    yum install -y \
    nginx \
    && yum clean all
# 可以将运行脚本拷贝根目录下
COPY run_nginx.sh /
CMD ["/run_nginx.sh"]
# 也可以拷贝到 /scripts/ 目录下，但要注意 CMD 的执行路径
#COPY run_nginx.sh /scripts/
#CMD ["/scripts/run_nginx.sh"]
```

- `docker build -t nginx:v1.1 .`

#### yaml

- 直接运行即可

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: test
spec:
  containers:
  - name: nginx
    image: nginx:v1.0
    # 以下变量如未指定则为默认值
    env:
    - name: NTP_SERVER1
      value: "172.16.0.125" # 指向公司内部时间同步服务器1
    - name: NTP_SERVER2
      value: "172.16.0.127" # 指向公司内部时间同步服务器2
    - name: MIRRORS_SERVER 
      value: "mirrors.tuna.tsinghua.edu.cn"
    securityContext:
      capabilities:
        add: ['CAP_SYS_TIME']
  # 运行在master节点用于测试
  nodeSelector:
    kubernetes.io/hostname: 'k8s-master1'
  tolerations:
  - key: node-role.kubernetes.io/master
    effect: NoSchedule
    operator: Exists
```





# python 基础镜像

## python 基础镜像说明

- python 基础镜像，是基于系统基础镜像的上层进行构建。

### 拉取指令

- **Ubuntu16.04-python3.6.8：**
  - `docker pull 172.16.0.120:30002/python/ubuntu1604-python368@sha256:5eff670ecca2ac87701b0273b1839b58b9e2e7232a8ee7397be9fc751da897f6`
- **Ubuntu18.04-python3.10.?：**
  - ...

### 支持的环境变量

- 基础镜像支持的变量，此镜像同样支持。

| key         | 说明       | default                                  | type   |
| ----------- | ---------- | ---------------------------------------- | ------ |
| PYPI_SOURCE | pip 源指向 | https://pypi.tuna.tsinghua.edu.cn/simple | string |

- 腾讯云：`https://mirrors.cloud.tencent.com/pypi/simple`
- 阿里云：`https://mirrors.aliyun.com/pypi/simple`
- 清华大学：`https://pypi.tuna.tsinghua.edu.cn/simple`
- 公司内部：`http://172.16.0.137:8081/repository/pypi/`



## 基于基础镜像构建业务镜像

### hello.py

- 测试使用的python代码

```python
#!/usr/bin/env python3
import time

log_file = '/var/log/hello.log'

while True:
    with open(log_file, 'a') as file:
        file.write('Hello, World!\n')
    time.sleep(1)

```



### 方法一

- 在 Dockerfile 的 CMD 中指定运行的业务**命令**

#### Dockerfile

```dockerfile
FROM 172.16.0.120:30002/python/ubuntu1604-python368@sha256:5eff670ecca2ac87701b0273b1839b58b9e2e7232a8ee7397be9fc751da897f6
COPY hello.py /
CMD ["/usr/local/bin/python3", "/hello.py"]
```

- `docker build -t python-demoapp:v1.0 .`

#### yaml

- 直接运行即可

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: python-demoapp
  namespace: test
spec:
  containers:
  - name: python-demoapp
    image: python-demoapp:v1.0
    # 以下变量如未指定则为默认值
    #env:
    #- name: NTP_SERVER1
    #  value: "172.16.0.125" # 指向公司内部时间同步服务器1
    #- name: NTP_SERVER2
    #  value: "172.16.0.127" # 指向公司内部时间同步服务器2
    #- name: MIRRORS_SERVER 
    #  value: "mirrors.tuna.tsinghua.edu.cn"
    #- name: PYPI_SOURCE 
    #  value: "https://mirrors.aliyun.com/pypi/simple" 
    securityContext:
      capabilities:
        add: ['CAP_SYS_TIME']
  # 运行在master节点用于测试
  nodeSelector:
    kubernetes.io/hostname: 'k8s-master1'
  tolerations:
  - key: node-role.kubernetes.io/master
    effect: NoSchedule
    operator: Exists
```

#### 验证

```sh
# kubectl exec -it -n test python-demoapp -- bash


root@python-demoapp:/# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.2  0.0  19024  6980 ?        Ss   16:14   0:00 /usr/local/bin/python3 /hello.py
root        10  0.0  0.0  26068  2448 ?        Ss   16:14   0:00 /usr/sbin/cron
root        15  0.3  0.0  18248  3404 pts/0    Ss   16:14   0:00 bash
root        27  0.0  0.0  34424  2916 pts/0    R+   16:14   0:00 ps aux


root@python-demoapp:/# tail -f /var/log/hello.log 
Hello, World!
Hello, World!
Hello, World!
...
```



### 方法二

- 在 Dockerfile 的 CMD 中指定运行的业务**脚本**

#### python-demoapp.sh

```sh
#!/bin/bash
/usr/local/bin/python3 /hello.py
```

- `chmod +x python-demoapp.sh`

#### Dockerfile

```dockerfile
FROM 172.16.0.120:30002/python/ubuntu1604-python368@sha256:5eff670ecca2ac87701b0273b1839b58b9e2e7232a8ee7397be9fc751da897f6
COPY hello.py /
COPY python-demoapp.sh /
CMD ["/python-demoapp.sh"]
```

- `docker build -t python-demoapp:v1.1 .`

#### yaml

- 直接运行即可

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: python-demoapp
  namespace: test
spec:
  containers:
  - name: python-demoapp
    image: python-demoapp:v1.1
    # 以下变量如未指定则为默认值
    #env:
    #- name: NTP_SERVER1
    #  value: "172.16.0.125" # 指向公司内部时间同步服务器1
    #- name: NTP_SERVER2
    #  value: "172.16.0.127" # 指向公司内部时间同步服务器2
    #- name: MIRRORS_SERVER 
    #  value: "mirrors.tuna.tsinghua.edu.cn"
    #- name: PYPI_SOURCE 
    #  value: "https://mirrors.aliyun.com/pypi/simple" 
    securityContext:
      capabilities:
        add: ['CAP_SYS_TIME']
  # 运行在master节点用于测试
  nodeSelector:
    kubernetes.io/hostname: 'k8s-master1'
  tolerations:
  - key: node-role.kubernetes.io/master
    effect: NoSchedule
    operator: Exists
```

#### 验证

```sh
# kubectl exec -it -n test python-demoapp -- bash


root@python-demoapp:/# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.2  0.0  18028  2840 ?        Ss   16:28   0:00 /bin/bash /python-demoapp.sh
root        10  0.0  0.0  26068  2440 ?        Ss   16:28   0:00 /usr/sbin/cron
root        15  0.1  0.0  19024  6996 ?        S    16:28   0:00 /usr/local/bin/python3 /hello.py
root        16  0.2  0.0  18248  3292 pts/0    Ss   16:28   0:00 bash
root        27  0.0  0.0  34424  2836 pts/0    R+   16:28   0:00 ps aux



root@python-demoapp:/# tail -f /var/log/hello.log 
Hello, World!
Hello, World!
Hello, World!
...
```

