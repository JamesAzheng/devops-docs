# 未做限制前

- 未做限制前，容器可以自由支配宿主机所有的内存资源

```sh
# 压测前
root@target-3-da-5-7d696b6f86-2hkvk:/# free -m
              total        used        free      shared  buff/cache   available
Mem:          32167        2678       22177           5        7312       29086
Swap:             0           0           0


# 执行压测脚本，模拟占用10G内存
root@target-3-da-5-7d696b6f86-2hkvk:/# ./memory_usage.py 10240
root@target-3-da-5-7d696b6f86-2hkvk:/# ps -C "memory_usage.py" -o pid,rss
  PID   RSS
 3059 10494608


# 压测后
# free -m
              total        used        free      shared  buff/cache   available
Mem:          32167       12943       11911           5        7312       18821
Swap:             0           0           0
```







# 做限制后

- 在容器定义中添加以下行，以限制该容器最大内存使用量为50M

```sh
  containers:
  - name: myapp
    image: <Image>
	# 添加以下行
    resources:
      limits:
        memory: "50Mi"
```

- 容器启动后，可以看到 tor 进程正常运行

```sh
root@target-3-da-4-5b7996bc87-gg6gh:/# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0  18384  3084 ?        Ss   17:01   0:00 /bin/bash /usr/local/bin/docker-entrypoint_da
root        10  0.0  0.0  28360  2712 ?        Ss   17:01   0:00 /usr/sbin/cron
root        48  0.4  0.0 730904 24204 ?        Sl   17:01   0:00 tor -f /etc/tor/torrc # 正常运行的tor进程
root        59  0.0  0.0   4636   788 pts/0    Ss+  17:02   0:00 sh
root        67  0.1  0.0  59440 17756 ?        S    17:02   0:00 python3 /usr/local/bin/monitor/node_monitor.py
root        68  0.0  0.0   4576   884 ?        S    17:02   0:00 tail -f /dev/null
root        74  0.0  0.0  18516  3532 pts/1    Ss   17:04   0:00 bash
root        84  0.0  0.0  18516  3388 pts/2    Ss+  17:04   0:00 bash
root        98  0.5  0.0  18516  3400 pts/3    Ss+  17:05   0:00 bash
root       108  0.0  0.0  34412  2908 pts/1    R+   17:05   0:00 ps aux
```

- 超出限制后，触发OOM，压测进程和 tor 进程都被 kill 掉（因为这两个进程占用内存最多）

```sh
# 执行压测脚本，模拟占用30M内存
root@target-3-da-4-5b7996bc87-gg6gh:/# ./memory_usage.py 30
Killed

# tor进程已被kill掉
root@target-3-da-4-5b7996bc87-gg6gh:/# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0  18384  3084 ?        Ss   17:01   0:00 /bin/bash /usr/local/bin/docker-entrypoint_da
root        10  0.0  0.0  28360  2712 ?        Ss   17:01   0:00 /usr/sbin/cron
root        67  0.0  0.0  59440 17756 ?        S    17:02   0:00 python3 /usr/local/bin/monitor/node_monitor.py
root        68  0.0  0.0   4576   884 ?        S    17:02   0:00 tail -f /dev/null
root        74  0.0  0.0  18516  3536 pts/1    Ss   17:04   0:00 bash
root        84  0.0  0.0  18516  3412 pts/2    Ss+  17:04   0:00 bash
root        98  0.0  0.0  18516  3432 pts/3    Ss+  17:05   0:00 bash
root       135  0.2  0.0   4636   932 pts/0    Ss+  17:08   0:00 sh
root       144  0.0  0.0  34412  2972 pts/1    R+   17:08   0:00 ps aux
```





# 结论

为容器定义资源限制后，如超出设定的阈值，将触发 OOM；

OOM 后会将当前容器中占用内存最多的一些进程 kill 掉，例如上述演示的 tor 进程。