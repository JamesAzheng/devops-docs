# 路由概述

路由是指网络中设备在转发数据时，根据目标IP地址选择最佳路径的过程。路由的目的是使数据能够有效地从源地址传输到目标地址，确保网络通信的可靠性和高效性。

路由器是实现路由功能的重要设备，它可以根据不同的路由协议（如OSPF、BGP等）来学习网络拓扑和路由信息，并根据学习到的信息来计算出数据包的最佳路径。

路由是TCP/IP协议族中的重要概念，它是实现数据通信的关键。在Internet中，路由器负责将数据包从源地址转发到目标地址，从而构成了庞大的互联网。



**路由表出现问题即使有IP地址网络也不能畅通**

路由表是一个记录网络中路由器的网络地址和端口的表格。它是路由器进行数据包转发的基础，能够决定数据包传输的路径和目的地。

如果路由表出现问题，可能会导致路由器无法正确地转发数据包，甚至无法确定正确的目的地，因此即使有IP地址网络也不能畅通。

例如，如果路由器将一个数据包发送到错误的网络，它将无法到达目的地，并返回错误消息。同样地，如果路由表中存在错误的路由信息，路由器可能会将数据包发送到错误的网络或错误的接口，导致无法正确转发数据包。这些问题可能会导致网络延迟、数据包丢失或其他网络问题。因此，正确配置和维护路由表是保持网络畅通的关键。



**路由表就相当于网络中的地图，**

是的，路由表可以理解为网络中的地图，其中记录了各个网络之间的连接方式和路径。



**跨网络通信必须配置路由**

当需要跨网络进行通信时，数据包需要通过路由表确定下一跳的路径和接口，才能到达目的地。

如果路由表配置有误或缺失，就会导致通信失败，即使IP地址正确，网络也不能畅通。

因此，在网络中进行跨网络通信时，必须正确配置路由表，才能保证数据的正常传输。



**访问本机的IP无需路由信息也可以访问**

是的，访问本机的IP地址无需路由信息也可以访问。

因为在本机的网络协议栈中，会有一个回环接口（Loopback Interface），通常对应的IP地址为 127.0.0.1，也称为localhost，用于本机内部的通信。

当本机的进程要访问自己的IP地址时，就会直接通过回环接口进行通信，而不需要经过物理网卡和路由器。

对于访问本机的IP无需路由信息也可以访问这一点，这是因为本机的网络接口已经知道如何到达本机的IP地址，因此不需要使用路由表进行路由选择。



**路由器是广域网设备，连接广域网，记录了到达某一个网络的路径（相当于网络中的地图），处于OSI七层参考模型的网络层（属于典型的三层设备）**

部分回答正确，我来补充一下。

路由器通常被称为广域网设备，因为它们主要用于连接不同的网络，例如连接家庭网络和互联网，或连接不同的分支机构。

路由器通过维护一张路由表来记录如何到达不同的网络。

路由器不仅仅处于OSI七层参考模型的网络层，而且是该层的核心设备，因为它们实现了网络层的主要功能，如寻址、转发和路由选择。此外，路由器也可以支持其他层的功能，如负载均衡、安全性等。



**路由器可以隔断广播域和冲突域**

是的，路由器可以隔断广播域和冲突域。

在一个局域网中，所有的设备都处于同一个广播域和冲突域中，这意味着它们可以直接进行广播和冲突检测。

但是，如果将路由器连接到局域网中，路由器会将广播域和冲突域隔离开来，使得每个子网都成为一个独立的广播域和冲突域，从而提高了网络的可靠性和安全性。





## 静态路由

- 静态路由是在网络管理员手动配置的路由。与动态路由不同，静态路由不会自动发现或适应网络的变化。网络管理员必须手动更新静态路由表以适应网络拓扑和需求的变化。
- 在静态路由中，管理员必须手动指定目标网络的下一跳路由器和接口。当一个数据包到达一个路由器，该路由器会检查其目的地网络地址，并将该数据包发送到静态路由表中与该目的地网络地址相匹配的下一个跳路由器。
- 静态路由通常用于简单网络拓扑或具有小型路由器数量的网络，因为在大型网络中管理静态路由可能会变得非常繁琐和不实际。



**路由中的下一跳是什么意思**

- 在计算机网络中，路由器通过查找路由表将网络数据包从源地址传递到目标地址。当路由器接收到一个数据包时，它会检查目标IP地址并决定向哪个方向转发该数据包。如果目标地址不在本地网络上，则路由器需要将该数据包转发到另一个路由器或者下一跳（Next Hop），以便继续寻找目标地址的路径。
- 下一跳是指在数据包在网络中传输时，下一个路由器或者网络设备的IP地址。它是路由表中的一个重要字段，用于指定下一步将数据包传递到哪个网络设备，以便最终到达目标地址。路由器通常需要将数据包转发到下一跳路由器，直到数据包到达目标网络或者主机。
- 在路由器中配置路由时，通常需要指定下一跳的IP地址，以便路由器能够正确地将数据包传递到下一个网络设备。如果路由器无法找到下一跳，它将无法正确地将数据包转发到目标地址，从而导致网络故障或者无法访问目标地址。因此，在配置路由时，正确指定下一跳是非常重要的。



**下一跳通常应该指向到哪**

- 下一跳指向应该是下一个可以到达目标地址的网络设备或者路由器。在路由表中，下一跳的地址通常是接口所连接的网络设备的IP地址。如果目标地址是一个本地网络上的主机，则下一跳地址是该主机的IP地址；如果目标地址不在本地网络上，则下一跳地址是下一个路由器的IP地址。
- 例如，当路由器接收到一个数据包时，如果目标地址不在其直接连接的网络中，则它将检查路由表中的下一跳地址，并将数据包转发到该地址所对应的下一个路由器。下一个路由器将继续执行相同的过程，直到数据包到达目标地址。
- 在实际网络中，路由器通过动态路由协议或静态路由表来确定最佳的下一跳地址。动态路由协议可以根据网络拓扑和链路状况自动计算最佳的下一跳，而静态路由表需要管理员手动配置下一跳地址。无论使用哪种方式，下一跳都应该指向一个可以到达目标地址的网络设备或路由器。



## 动态路由

- 动态路由是一种网络协议，它允许路由器动态地学习和适应网络拓扑和路由变化。
- 路由器会自动收集和交换路由信息，并通过路由算法计算出最佳路径，将数据包发送到目的地。
- 动态路由协议的目的是为了使路由器能够自动地选择最佳路径，从而提高网络性能和可靠性。
- 常见的动态路由协议包括：OSPF、RIP、EIGRP、BGP等。
  - 当路由器收到来自邻居路由器的路由信息时，它会更新自己的路由表，并且定期发送更新信息以确保路由信息保持最新。
  - 不同的路由协议在实现方式、特点和适用场景上都有所不同，根据具体需求选择合适的路由协议非常重要。
- 动态路由通常用于大型网络中，因为它们可以自适应网络变化，并自动发现新的网络设备和路径。但是，动态路由协议的配置和管理需要更多的时间和努力，并且可能会在某些情况下导致不必要的路由交换和网络拥塞。



### OSPF

- Open Shortest Path First，开放式最短路径优先
- 是一种基于链路状态（Link-State）的路由协议，常用于局域网和中等规模的企业网络中。OSPF协议使用Dijkstra算法计算最短路径，并根据链路状态数据库（LSDB）计算最佳路径。



OSPF（Open Shortest Path First）是一种常用的链路状态路由协议，用于大型企业网络。 OSPF旨在通过维护包含网络中所有路由器和链路信息的拓扑数据库，提供快速的收敛和高效的网络资源利用。网络中的每个路由器使用链路状态广告（LSA）向其OSPF邻居广告其可用路由，然后将其泛洪到整个网络，以确保每个路由器都具有完整准确的网络拓扑视图。

OSPF使用成本度量标准，该标准基于链接的带宽，以确定到达目标网络的最佳路径。 OSPF支持到达目标网络的多条路径和这些路径的负载均衡。 OSPF还支持区域的概念，允许分层网络设计，并通过将网络划分为较小的段来减少拓扑数据库的大小。

OSPF具有许多功能，使其成为企业网络的首选，包括：

- 快速收敛： OSPF旨在快速适应网络拓扑的变化，非常适合具有许多路由器和链接的大型网络。
- 可扩展性： OSPF支持分层网络设计，允许高效利用网络资源，并减小拓扑数据库的大小。
- 负载平衡： OSPF支持等成本多路径（ECMP）路由，允许在到达目标网络的多个路径上进行负载平衡。
- 安全： OSPF包括身份验证和加密等功能，以确保只有经过授权的设备可以参与路由过程，并保护路由信息免受未经授权的访问。
- 厂商独立： OSPF是一种开放标准协议，受到广泛支持的网络供应商支持，易于在异构网络环境中实现。

总的来说，OSPF是一种强大而灵活的路由协议，非常适合大型企业网络。



### BGP

- Border Gateway Protocol，边界网关协议

- 是一种自治系统间（AS间）的路由协议，常用于互联网中的路由选择。BGP协议的主要特点是可靠性和灵活性，能够支持大规模网络中的多路径路由选择。



BGP（Border Gateway Protocol）是一种路径向量路由协议，主要用于在互联网上的自治系统（AS）之间传递路由信息。BGP通过交换路由信息（称为BGP路由器通告）来决定最佳路径，使得数据包可以沿着最佳路径到达目标AS。BGP路由器还可以选择拒绝某些路由通告，以确保网络的安全和稳定性。

BGP有以下几个主要特点：

- 处理大型网络： BGP适用于大型网络，能够处理成千上万个网络、路由器和子网。
- 路由策略控制： BGP允许管理员设置路由策略，选择最佳路径，并拒绝某些路由通告，以确保网络的安全和稳定性。
- 多路径选择： BGP支持多路径选择，可以选择到达目标AS的多个路径。
- 厂商独立： BGP是一种开放标准协议，不受任何特定厂商控制，因此可以在各种不同类型的路由器和操作系统中实现和使用。

总的来说，BGP是一种用于大型互联网网络的强大路由协议，可以帮助管理员控制网络的路由策略，并确保网络的安全和稳定性。



### RIP

- Routing Information Protocol，路由信息协议
- 是一种基于距离向量（Distance-Vector）的路由协议，是最早的互联网路由协议之一。RIP协议使用跳数作为路由选择的指标，并通过周期性的路由更新来维护路由信息。



RIP（Routing Information Protocol）是一种距离向量路由协议，用于在小型局域网中传递路由信息。RIP将路由表中的跳数作为距离，计算到达目标网络的最佳路径。当路由器在网络上更改时，它会广播更新消息，使其他路由器更新其路由表。

RIP有以下几个主要特点：

- 简单易用： RIP非常易于设置和配置，适用于小型网络。
- 学习速度快： RIP使用距离向量算法，计算最短路径的时间相对较短，适合在小型网络中使用。
- 适用于小型网络： RIP适用于小型网络，因为它不能处理大型网络的复杂性，如跨越多个网络和子网的复杂路由。
- 不支持VLSM： RIP不支持可变长度子网掩码（VLSM），因此无法在同一网络中使用不同大小的子网。

尽管RIP易于配置和使用，但它已经被许多更先进的路由协议所替代，这些协议能够更好地适应大型网络中的复杂性。其中一些协议包括OSPF、EIGRP和BGP等。



### EIGRP

EIGRP（Enhanced Interior Gateway Routing Protocol）是一种距离向量路由协议，由思科系统公司开发，用于在企业内部网络中传递路由信息。EIGRP使用可变长度子网掩码（VLSM）和快速收敛技术，能够快速计算最短路径和适应网络拓扑的变化。

EIGRP有以下几个主要特点：

- 快速收敛： EIGRP采用快速收敛技术，能够快速适应网络拓扑的变化，同时减少网络的收敛时间。
- 可变长度子网掩码： EIGRP支持可变长度子网掩码（VLSM），可以在同一网络中使用不同大小的子网，提高网络的灵活性。
- 路由协议独立性： EIGRP可以在多种路由协议之上运行，包括IPv4和IPv6等。
- 智能路由选择： EIGRP采用了DUAL算法，可以选择最佳路径，并根据带宽、延迟、可靠性和负载等因素进行智能路由选择。
- 压缩路由信息： EIGRP可以通过压缩路由信息来减少网络的带宽占用。

总的来说，EIGRP是一种快速、灵活和智能的路由协议，适用于大型企业网络中的路由选择。由于EIGRP是思科系统公司的专有协议，因此只能在思科设备上使用。



### 动态路由模拟工具

Linux中动态路由相关模拟工具：

- 通过守护进程获取动态路由，安装quagga包,通过命令vtysh配置

除了Quagga，Linux中还有其他动态路由相关模拟工具，例如：

- Bird：一个高性能的路由器软件，支持多种动态路由协议，如BGP、OSPF、RIP等。
- FRRouting：一个开源的路由器软件，支持多种动态路由协议，如BGP、OSPF、RIP等。
- OpenBGPD：一个开源的BGP路由器软件，主要用于自治系统内的路由器之间的BGP通信。

这些工具都提供了类似Quagga的配置方式，可以通过命令行界面或配置文件进行动态路由的设置和管理。





## 路由记录类型

### 主机路由

- 主机路由，是到达某一个主机的路由（指针对某个具体的目的IP地址进行路由规划）

**主机路由的 Genmask 一定都为 255.255.255.255，因为 Genmask 为 255.255.255.255 时表示的是一个单独的主机**

部分正确。的确，对于主机路由，Genmask应该设置为255.255.255.255，因为这意味着该路由条目适用于一个单独的主机，而不是一个网络范围。当一个路由条目的Genmask为255.255.255.255时，它表示只有一个特定的IP地址与该路由匹配，即目标地址是一个单独的主机。

但是，这并不意味着所有Genmask为255.255.255.255的路由都是主机路由。例如，对于某些VPN或隧道连接，Genmask为255.255.255.255的路由条目可能表示该路由适用于整个隧道连接，而不仅仅是一个单独的主机。

因此，可以说主机路由的Genmask一定是255.255.255.255，但不是所有Genmask为255.255.255.255的路由都是主机路由。

**主机路由示例：**

```sh
# 主机路由的目的地址会被指定为具体的IP地址，第一条为主机路由，目的地址为 192.168.1.1
# route -n
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
192.168.2.0     0.0.0.0         255.255.255.0   U     200    0        0 eth1
0.0.0.0         192.168.1.254   0.0.0.0         UG    100    0        0 eth0
```



### 网络路由

- 网络路由，是到达某一个网段的路由（指针对某个网络段进行路由规划）
- 是的，您说的是正确的。网络路由（network route）是指到达某个特定网络段的路由，也可以称为子网路由（subnet route）。
- 在网络拓扑中，一个网络通常由多个主机组成，每个主机都有一个唯一的IP地址。网络路由是将数据包从一个网络发送到另一个网络的路径，**它指向的是一个特定的网络地址和子网掩码，而不是一个特定的主机。**
- 网络路由通常由网络管理员手动配置或动态路由协议自动计算，以便在网络中选择最佳的路径。当网络中的一个主机要发送数据包到目标网络时，数据包将首先到达本地路由器，然后本地路由器将使用路由表中的网络路由来选择传送数据包的下一跳路由器，直到数据包到达目标网络的目的地。网络路由是互联网通信的基础，能够连接不同的网络，并使其能够互相通信。

**网络路由的 Genmask 一定不是 255.255.255.255 或 0.0.0.0**

是的，网络路由的Genmask一定不是255.255.255.255或0.0.0.0。

网络路由通常指一个IP地址范围，而不是一个单独的主机或所有主机（如默认路由）。因此，网络路由的Genmask应该设置为一个能够表示目标IP地址范围的值。例如，如果一个路由条目用于匹配一个C类网络，那么其Genmask可能设置为255.255.255.0，表示该路由适用于该网络中的所有主机。

**网络路由示例：**

```sh
# 网络路由的目的地址则会被指定为网络段，第二条为网络路由，目的网段为 192.168.2.0/24
# route -n
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
192.168.2.0     0.0.0.0         255.255.255.0   U     200    0        0 eth1
0.0.0.0         192.168.1.254   0.0.0.0         UG    100    0        0 eth0
```

**添加网络路由：**

```sh
# 添加网络路由（去往10.244.0.0/16 这个网段需要经由10.0.0.100这个网关）
route add -net 10.244.0.0/16 gw 10.0.0.100
```





### 默认路由

- 默认路由则是指没有匹配到任何路由表项时所采用的默认路由。

- 0.0.0.0/0，到哪任何网段都需要从本路由器出去**默认路由只能有一条**
- 当网络设备处于整个网络**边界**的时候就需要配默认路由，反之如处于整个网络的中心点则无需配置

```bash
# Destination 为 0.0.0.0 即为默认路由
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.244.1.1      0.0.0.0         UG    0      0        0 eth0
...
```

**默认路由的 Genmask 一定都为 0.0.0.0**

是的，对于默认路由，其Genmask一定都为0.0.0.0。默认路由用于指示当没有其他路由表项匹配目标IP地址时，应该将数据包发送到哪个网关。由于默认路由将所有目标IP地址都匹配到该路由，因此其Genmask必须为0.0.0.0。



在Linux中，使用 `route -n` 命令可以查看系统当前的路由表，其中主机路由的目的地址会被指定为具体的IP地址，网络路由的目的地址则会被指定为网络段，而例如：

```sh
# 默认路由会被指定为 0.0.0.0，第三条为默认路由，目的地址为 0.0.0.0
# route -n
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.1     0.0.0.0         255.255.255.255 UH    100    0        0 eth0
192.168.2.0     0.0.0.0         255.255.255.0   U     200    0        0 eth1
0.0.0.0         192.168.1.254   0.0.0.0         UG    100    0        0 eth0
```



### 判断路由类型

一般来说，以下规则可以帮助您确定路由类型：

1. 如果目标IP地址是一个单独的主机，那么这是一个主机路由。在路由表中，该主机的IP地址和子网掩码通常都是255.255.255.255。
2. 如果目标IP地址是一个网络范围，那么这是一个网络路由。在路由表中，该网络的IP地址和子网掩码通常表示网络的地址范围，而不是单独的主机。
3. 如果目标IP地址为0.0.0.0，则这是一个默认路由。默认路由的子网掩码通常是0.0.0.0。

请注意，这只是一般规则，并不是绝对的规则。特定网络或路由配置可能会导致不同的路由类型，因此需要查看完整的路由表条目来确定路由类型。



## 路由优先级

路由优先级指的是在多个路由表项中，当目标 IP 匹配多个表项时，系统如何选择最终的路由。一般来说，优先级高的路由表项会被选择。

在 Linux 中，路由优先级的判断顺序如下：

1. 直接连接的路由，即与本机直接相连的网络。这类路由具有最高的优先级，因为数据包可以直接通过物理接口到达。
2. 静态路由表。静态路由表是管理员手动配置的路由表项，可以指定目标网络或者主机、下一跳等信息。静态路由表的优先级高于动态路由表，因为静态路由表是管理员手动配置的。
3. 动态路由表。动态路由表是由路由协议（如 OSPF、BGP 等）计算得出的路由表项，这些协议可以自动调整路由表以应对网络拓扑的变化。
4. 默认路由。当目标网络或主机不匹配任何已知的路由表项时，数据包将使用默认路由，这类路由表项的优先级最低。

值得注意的是，即使是在同一个优先级下，不同的路由协议也可能存在优先级的差异。例如，在 Linux 中，BGP 的优先级要高于 OSPF。



**是精度越高，则优先级越高吗？**

在路由优先级中，精度越高并不一定意味着优先级越高。路由的优先级是由不同因素综合决定的，如下：

1. 目标地址匹配度：路由表中匹配目标地址最精确的路由优先级最高。
2. 路由类型：直连路由的优先级最高，因为直连路由是最可靠、最直接的路径。
3. 距离度量：不同的路由协议使用不同的距离度量算法，如RIP使用跳数，OSPF使用链路带宽、路由器资源等多个因素综合计算。通常情况下，距离越短的路由优先级越高。
4. 路由策略：管理员可以通过设置路由策略来调整路由优先级，如手动指定某个路由的优先级或添加路由策略。
5. 路由缓存：操作系统可能会缓存最近使用过的路由，这些路由的优先级可能会提高。

因此，在路由优先级中，精度只是其中一个因素，其他因素的影响也很重要。







## 网关 Gateway

在网络中，网关（Gateway）是一种特殊的网络设备或计算机，它连接两个或多个网络，将数据从一个网络路由到另一个网络。

网关一般位于网络边缘，相当于网络的出入口，是连接不同网络的一个关键节点。

在计算机中，网关通常是指用于连接本地网络与Internet的路由器，也可以是连接两个不同局域网的交换机或路由器。

在配置网络设备的时候，通常需要设置网关的IP地址，以便该设备能够访问其他网络中的主机。



**路由中的网关是什么意思**

在网络中，网关（Gateway）是一个网络连接设备，通常是一台路由器，其作用是将两个或多个不同的网络连接在一起，使得它们能够相互通信。

网关常常被用于连接局域网（LAN）和广域网（WAN），以便局域网内的计算机能够访问广域网上的资源，例如互联网。

在路由器上配置的网关地址通常是网络中的默认网关，也就是当路由器无法找到目标网络时，会将数据包发送到默认网关进行转发。



**网关就是路由器临近本主机接口的IP地址吗**

是的，网关就是在本地主机所连接的网络中与本地主机所连接的子网之间的设备或者接口的 IP 地址。

在路由器或者交换机上，其所连接的本地子网地址就是该设备或者接口的 IP 地址，可以被视为该子网的网关地址，提供外部网络与子网通信的桥梁。

在本地主机中，网关就是通过路由表来指向下一跳的 IP 地址。



**跨网段通信必须配置网关吗**

是的，跨网段通信必须要配置网关。

在网络通信中，不同的网段使用不同的IP地址，如果要跨网段进行通信，就需要通过网关进行数据包的转发。

网关是位于两个网络之间的一个网络设备，用于在不同的网络之间进行数据包的转发。



**服务器的网关应该指向路由器而不是交换机**

在多台服务器使用一个交换机互联，并且路由器也与交换机互联的情况下，服务器的网关应该指向路由器而不是交换机。

交换机的作用是将数据包转发到它们的目标设备，而路由器的作用则是根据目标IP地址和子网掩码，将数据包从一个网络传输到另一个网络。因此，如果服务器的网关指向交换机而不是路由器，数据包可能会被限制在同一网络中，无法到达目标网络。

另外，如果服务器的网关指向路由器，路由器可以负责将数据包转发到正确的网络，而不需要交换机进行额外的处理，这可以提高网络性能和安全性。



**因为交换机与路由器和服务器之间都是互联的，所以服务器可以直接将网关指向路由器，数据包可以经过交换机直接到达路由器，对吗？** 

是的，如果交换机、路由器和服务器之间都已经建立了正确的物理连接和网络配置，服务器可以将其网关指向路由器，数据包可以通过交换机直接到达路由器。这是因为在现代网络中，交换机和路由器都可以提供高速数据传输和流量控制，以确保数据包能够快速且安全地传输到目标设备。

当服务器向目标设备发送数据包时，数据包首先会被发送到交换机，交换机会检查数据包的目标MAC地址，并将其转发到与该地址相应的端口。然后，路由器会接收到数据包并检查其目标IP地址，如果该地址属于另一个网络，路由器将转发数据包到正确的网络。最终，目标设备会接收到数据包并做出响应。

需要注意的是，为了确保网络安全性和稳定性，交换机、路由器和服务器之间的网络配置需要正确设置，包括IP地址、子网掩码、网关和DNS等参数。如果配置不正确，可能会导致数据包传输失败、网络故障和安全漏洞等问题。因此，建议在进行网络配置时，遵循网络安全和最佳实践的原则。



**同网段通信，网关是不是可以不配置**

是的，如果两台设备处于同一个子网（网段），则可以直接进行通信，不需要配置网关。



**默认网关**

指向临近主机的路由器的地址，**跨网络通讯必须配网关**（**配置网关的目的就是为了设置默认路由**，华山一条路，访问别的网络只能从下一个路由器出去）

```bash
# Destination 为 0.0.0.0 然后 Gateway 所指向的 10.244.1.1 即为默认网关
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.244.1.1      0.0.0.0         UG    0      0        0 eth0
...
```




**路由中的默认网关是什么意思**

在路由表中，如果没有明确的匹配项可用于目标IP地址的路由，则会使用默认路由。

默认路由是指用于匹配所有不包含在路由表中的目标网络的路由。

**通常情况下，将默认路由设置为网关的IP地址，以便当主机要访问其他网络时，可以将所有未知的目标地址流量转发到默认网关进行转发。**

- 例如，假设主机A要访问IP地址为192.168.2.10的主机B，但是主机A的路由表中没有关于192.168.2.0/24网段的路由，那么主机A就会将流量发送到默认网关所在的网络，然后由路由器进行转发，直到到达主机B所在的网络。




**默认网关在 route -n 的输出中是怎样表现的，如何区分默认网关**

在 `route -n` 命令的输出中， 默认网关 表示为 `0.0.0.0` 的目标地址，对应的网关地址一般是本地接口连接到路由器的IP地址。

例如：

```sh
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 eth0
```

其中，`0.0.0.0` 表示默认路由，`192.168.1.1` 是默认网关的IP地址，`UG` 表示网关类型是用户设置的默认网关，`eth0` 是通过哪个接口连接到默认网关的。





**下一跳是网关吗**

在路由表中，下一跳（Next Hop）通常是指路由数据包的下一个目的地。

当一个数据包到达一个路由器时，该路由器需要决定向哪里转发数据包，这时会使用路由表来确定下一跳。

通常情况下，下一跳是指一个网关（Gateway），即路由器可以将数据包发送到该网关，然后该网关将数据包转发到目标主机。

但是，并不是所有情况下下一跳都是一个网关。在某些情况下，下一跳可能是直接连接到当前路由器的网络或主机。例如，在本地网络中，如果路由器需要转发数据包到本地网络上的其他主机，则下一跳可能是该本地网络上的一个主机。因此，下一跳并不一定是网关，但在大多数情况下，下一跳指的是一个网关。





**在Windows中使用wmware创建Linux虚拟机时，为什么默认的网关指向的是10.0.0.2**

当您在Windows中使用VMware创建Linux虚拟机时，默认的网关地址（Gateway）指向的是10.0.0.2，这是因为VMware默认使用的网络配置是NAT（Network Address Translation）模式。

在NAT模式下，VMware会为虚拟机创建一个虚拟网络，该网络与主机的物理网络相隔离。虚拟机通过VMware虚拟网络适配器连接到该虚拟网络，并使用VMware虚拟DHCP服务器为虚拟机提供IP地址、子网掩码和网关地址等网络配置信息。默认情况下，VMware虚拟DHCP服务器会分配10.0.0.2作为网关地址。

因此，如果您的虚拟机使用NAT模式连接到虚拟网络，则默认网关地址应该是10.0.0.2。如果您需要更改网关地址，可以在虚拟机中手动配置新的网关地址。具体方法取决于您使用的Linux发行版和网络配置工具。



**如何知道网关应该定义为什么地址**

要确定网关应该设置为什么地址，需要考虑以下几个因素：

1. 网络拓扑结构：网关应该设置为连接到其他网络的接口的地址。如果只有一个路由器连接到互联网，那么该路由器的IP地址就应该设置为网关。如果有多个路由器或者交换机，那么需要根据网络拓扑来确定网关地址。
2. IP地址子网掩码：网关地址必须与本地网络的IP地址子网掩码匹配。如果IP地址子网掩码不正确，则网络通信可能会失败。
3. DHCP设置：如果使用动态主机配置协议（DHCP）来自动配置IP地址和网关，则网关地址会自动分配。在这种情况下，无需手动配置网关地址。
4. 网络管理员建议：如果您不确定应该将网关设置为什么地址，请咨询网络管理员或者网络工程师。他们可以为您提供正确的设置建议。

总之，为了确定正确的网关地址，需要了解网络拓扑结构，IP地址子网掩码和DHCP设置，以及咨询网络管理员的建议。



## 总结

**路由表就相当于网络中的地图，网关相当于家门口的大门。如果要去往别的网络就必须依赖于路由表(地图)，才能找到应该走的路径，但出发前，应该先从家门口的大门(网关)先出去。但如果目标地址和本机处于同一网段，就相当于在自己家，在自己家走路就不需要网关这个大门了**

非常好的比喻！路由表确实类似于网络中的地图，它告诉网络设备如何路由数据包到达目标网络。而网关则是网络中连接到其他网络的设备，通过它可以将数据包路由到其他网络。

在同一网络段内，数据包可以直接通过数据链路层进行通信，不需要经过网关。只有当目标地址不在本地网络内时，才需要使用网关将数据包发送到其他网络。而通过路由表，网络设备可以确定将数据包发送到哪个网关以及通过哪些路由器和交换机来到达目标网络。



**还有其他形象的比喻吗**

当然！这里还有一些形象的比喻：

1. 路由表就像一张地图，网关就像是通往目的地的门。要到达其他网络，就需要查看地图确定路由，然后通过门前往目的地。
2. 路由表就像是交通指南，网关就像是出口。要到达目的地，就需要根据交通指南上的路线找到出口，然后通过出口到达目的地所在的网络。
3. 路由表就像是邮递员的邮路表，网关就像是邮局。邮递员需要根据邮路表确定送信的路线，然后将信件交给邮局，由邮局将信件发送到其他地方。

总之，路由表是网络中的重要组成部分，它告诉网络设备如何路由数据包到达目标网络。而网关是将数据包从一个网络发送到另一个网络的设备，通过它可以将数据包路由到其他网络。



# Linux 路由管理工具

- 以下工具可以用来配置和管理静态路由、动态路由、策略路由等。

## 显示当前路由表

- `route -n` 或 `ip route show`
- 这条命令将显示当前内核的路由表，包括目标网络、下一跳地址、网络接口和路由标志等信息。



## 添加路由

- `route add` 或 `ip route add`

添加路由需要指定目标网络和下一跳地址，语法为 `route add 目标网络地址 netmask 子网掩码 下一跳地址` 或 `ip route add 目标网络地址/子网掩码 via 下一跳地址`。例如，要将网段 `192.168.10.0/24` 的数据包发送到网关 `192.168.1.1`，可以使用命令：

```
route add -net 192.168.10.0 netmask 255.255.255.0 gw 192.168.1.1
```

或

```
ip route add 192.168.10.0/24 via 192.168.1.1
```



## 删除路由

- `route del` 或 `ip route del`

删除路由需要指定目标网络和下一跳地址，语法为 `route del 目标网络地址 netmask 子网掩码 下一跳地址` 或 `ip route del 目标网络地址/子网掩码 via 下一跳地址`。例如，要删除网段 `192.168.10.0/24` 的路由，可以使用命令：

```
route del -net 192.168.10.0 netmask 255.255.255.0
```

或

```
ip route del 192.168.10.0/24
```



## 修改路由

`route change` 或 `ip route change`

修改路由需要指定目标网络和下一跳地址，语法和添加路由类似。例如，要将网段 `192.168.10.0/24` 的下一跳地址修改为 `192.168.1.2`，可以使用命令：

```
route change -net 192.168.10.0 netmask 255.255.255.0 gw 192.168.1.2
```

或

```
ip route change 192.168.10.0/24 via 192.168.1.2
```



## 设定默认路由

`route add default` 或 `ip route add default`

设定默认路由的语法为 `route add default gw 下一跳地址` 或 `ip route add default via 下一跳地址`。例如，要将所有未知目标网络的数据包发送到网关 `192.168.1.1`，可以使用命令：

```
route add default gw 192.168.1.1
```

或

```
ip route add default via 192.168.1.1
```



## 查看特定目标网络的路由

- `route -n get` 或 `ip route`



## route -n 输出说明

- Destination：目标网络地址，指的是该路由表项所描述的目标网络的地址范围，可以是一个网络地址（如192.168.0.0），也可以是一个主机地址（如192.168.0.1）。
- Gateway：下一跳网关地址，指的是将数据包转发到目标网络时，需要经过的下一个路由器的IP地址。
- Genmask：子网掩码，用于将IP地址分为网络地址和主机地址两部分。子网掩码一般以255.255.255.0这样的形式表示，其中的1表示网络地址部分，0表示主机地址部分。
- Flags：标志，用于描述该路由表项的一些特性，常见的标志有U、G、H、D等。其中，
  - U表示该路由表项是活动的
  - G表示需要经过网关才能访问目标网络
  - H表示目标是一个主机地址
  - D表示该路由表项是由其他路由协议动态添加的。

- Metric：度量值，指的是到达目标网络的距离，通常是跳数或者延迟。度量值越小，表示到目标网络的距离越近。
- Ref：引用计数，表示该路由表项被引用的次数。当该路由表项不再被任何进程引用时，就可以被删除。
- Use：使用计数，表示该路由表项被使用的次数。
- Iface：接口名称，指的是数据包从哪个网络接口发送出去，例如eth0、wlan0等。



## ip route 输出说明

```sh
# ip route 
default via 172.27.191.253 dev eth0 proto dhcp metric 100 
10.8.0.0/16 via 10.8.0.2 dev tun0 
10.8.0.2 dev tun0 proto kernel scope link src 10.8.0.1 
172.27.176.0/20 dev eth0 proto kernel scope link src 172.27.185.115 metric 100 
```

- `default via 172.27.191.253 dev eth0 proto dhcp metric 100`：

这是默认路由规则，它告诉系统所有没有匹配到其他路由规则的流量都应该被发送到网关地址172.27.191.253，使用eth0接口进行发送。这个路由规则是由DHCP协议自动配置的，metric 100表示这个规则的优先级较高。

- `10.8.0.0/16 via 10.8.0.2 dev tun0`：

这个规则告诉系统，所有目的地址属于10.8.0.0/16这个网段的数据包，应该通过tun0接口发往10.8.0.2这个网关地址。

- `10.8.0.2 dev tun0 proto kernel scope link src 10.8.0.1`：

这个规则告诉系统，如果要发送到10.8.0.2这个地址，应该通过tun0接口直接发送。这个规则的scope是link，表示这个路由规则只在本机有效，而不会被传递到其他主机上。

- `172.27.176.0/20 dev eth0 proto kernel scope link src 172.27.185.115 metric 100`：

这个规则告诉系统，所有目的地址属于172.27.176.0/20这个网段的数据包，应该直接通过eth0接口发送，源IP地址为172.27.185.115。metric 100表示这个规则的优先级与默认路由规则相同。这个规则的proto为kernel，表示这是由系统内核自动生成的路由规则。scope为link，表示这个规则只在本机内有效。



## systemd-networkd

一个系统服务，提供了网络配置和管理的功能，包括路由配置。



## NetworkManager

用于管理网络连接的守护进程，提供了命令行和GUI工具来配置路由和网络连接。





# Linux 持久保存路由表

**写出添加临时和永久路由的命令，服务器与 192.168.52.0/21 子网通信的路由，网卡 ens33，网关 192.168.52.1**

- 添加临时路由

  - ```sh
    # 方法一
    ip route add 192.168.52.0/21 via 192.168.52.1 dev ens33
    
    # 方法二
    route add -net 192.168.52.0/21 gw 192.168.52.1 dev ens33
    ```

- 添加永久路由

  - ```sh
    # vim /etc/sysconfig/network-scripts/route-ens33
    192.168.52.0/21 via 192.168.52.1 dev ens33
    ```

- 如果想让此永久路由在不重启系统的情况下生效：

  - 方法一：`ip route add 192.168.52.0/21 via 192.168.52.1 dev ens33`
    - 添加一条同样的路由，推荐使用
  - 方法二：`nmcli connection reload`
    - 此命令将重新加载系统中的所有网络连接配置，包括您在 /etc/sysconfig/network-scripts/route-ens33 文件中添加的永久路由。这将使新的路由生效而无需重启系统。
    - 请注意，使用 nmcli 命令重新加载网络连接配置可能会导致您在运行期间进行的其他网络更改（例如添加新的网络连接或更改网络设置）丢失。因此，建议在进行此操作之前备份您的网络连接配置文件。





# Example - 多路由转发实验

## 目标

**实现A和B主机之间相互能ping同**

- 路由器无需配置网关
- 临近路由器的路由表在创建IP地址的时候会自动生成
- 如果路由器处在网络的最边缘，且目的只是从A机器到达B机器，则设置下一跳的默认路由即可

**#实验前需关闭防火墙和selinux**



![路由表实验](Net_images\路由表实验.png)



## R1路由表配置：

```bash
#正常配置
route add -net 172.20.0.0/16 gw 172.18.0.201 dev eth1
route add -net 172.22.0.0/16 gw 172.18.0.201 dev eth1

#注意
#👇如果路由器处在网络的最边缘，且目的只是从A机器到达B机器，则设置下一跳的默认路由即可
route add default gw 172.18.0.201 dev eth1
```



## R2路由表配置：

```bash
route add -net 172.16.0.0/16 gw 172.18.0.200 dev eth0
route add -net 172.22.0.0/16 gw 172.20.0.201 dev eth1
```



## R3路由表配置：

```bash
#正常配置
route add -net 172.16.0.0/16 gw 172.20.0.200 dev eth0
route add -net 172.18.0.0/16 gw 172.20.0.200 dev eth0

#注意
#👇如果路由器处在网络的最边缘，且目的只是从A机器到达B机器，则设置下一跳的默认路由即可
route add default gw 172.20.0.200 dev eth0
```

## ipforward（启动路由器转发功能）

**主机充当路由器时需开启此功能**

#### 方法一：临时生效

```bash
#需要修改内核参数
sysctl -a |grep ip_forward
net.ipv4.ip_forward = 0 #0表示不启用转发

cat /proc/sys/net/ipv4/ip_forward
0	#在磁盘上的显示

echo 1 > /proc/sys/net/ipv4/ip_forward #启用
```

#### 方法二：永久生效

```bash
echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf #追加此行

sysctl -p #执行此命令
```

## 最终配置总览：

- **注意：如果路由器处在网络的最边缘，且目的只是从A机器到达B机器，则设置下一跳的默认路由即可**

```
R1:   目标              网关          网卡
   172.20.0.0/16    172.18.0.201    eth1
   172.22.0.0/16    172.18.0.201    eth1
   
R2:   目标              网关          网卡
   172.16.0.0/16    172.18.0.200     eth0
   172.22.0.0/16    172.20.0.201     eth1

R3:   目标              网关          网卡
   172.16.0.0/16    172.20.0.200     eth0
   172.18.0.0/16    172.20.0.200     eth0
```



# Example - 单臂路由实验

单臂路由（Single-arm routing）是指在一个网络设备（通常是路由器或防火墙）只有一个接口连接到网络中的情况下，通过配置路由规则实现与其他网络的通信。

通常情况下，路由器或防火墙需要至少有两个接口来连接不同的网络。但是在一些特殊情况下，例如对于一些小型网络或者资源受限的设备，为了简化网络结构或减少硬件成本，可以采用单臂路由来实现不同网络之间的通信。

在单臂路由中，网络设备只有一个接口连接到网络，该接口同时也是设备与其他网络通信的唯一路径。通过在路由设备上配置路由规则，将来自不同网络的数据包转发到正确的目的地。同时，单臂路由还可以通过NAT（网络地址转换）来实现多个IP地址共享一个公共IP地址的功能。



### 实验目标

- 实现6.6.6.6与8.8.8.8之间的通信

### 方案一

- 添加路由器

<img src="C:\Users\阿征\Desktop\Work_Notes\Network\Net_images\单臂路由实验.png" alt="单臂路由实验" style="zoom: 50%;" />

### 方案二

- 直接添加 0.0.0.0 的默认路由

<img src="C:\Users\阿征\Desktop\Work_Notes\Network\Net_images\单臂路由实验2.png" alt="单臂路由实验2" style="zoom:50%;" />

- **原理：因为两台主机本身物理上就连接在一起，所以可以添加一条0.0.0.0默认路由，让其直接在网络中发送arp广播，因为本身两台主机物理上就连接在一起，所以另一方就可以收到，从而实现通信**

```bash
#A host
# ip route add default dev eth0
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref   
0.0.0.0         0.0.0.0         0.0.0.0         U     0      0     #新添加的
6.6.6.0         0.0.0.0         255.255.255.0   U     0      0     
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0     


#B host
# ip route add default dev eth0
# route -n
# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref   
0.0.0.0         0.0.0.0         0.0.0.0         U     0      0     
8.8.8.0         0.0.0.0         255.255.255.0   U     0      0     
10.0.0.0        0.0.0.0         255.255.255.0   U     0      0     


#测试
# ping -I 6.6.6.6 8.8.8.8
...
64 bytes from 8.8.8.8: icmp_seq=166 ttl=64 time=0.926 ms
...

#ARP广播
# tcpdump -nn arp
...
18:25:13.844408 ARP, Request who-has 6.6.6.6 tell 10.0.0.101, length 28
18:25:13.845902 ARP, Reply 6.6.6.6 is-at 00:0c:29:cd:b5:7f, length 46
18:25:14.002549 ARP, Request who-has 8.8.8.8 tell 10.0.0.100, length 46
18:25:14.002579 ARP, Reply 8.8.8.8 is-at 00:0c:29:0d:63:cd, length 28
...
```











# 持久保存路由规则

可以使用 `ip route` 命令添加网络路由规则，并将规则保存到 `/etc/sysconfig/network-scripts/route-<interface>` 文件中。例如，要将 `192.168.1.0/24` 网络地址添加到 `eth0` 接口的路由表中，可以使用以下命令：

```sh
sudo ip route add 192.168.1.0/24 via 192.168.0.1 dev eth0
```

然后，将该路由规则保存到 `/etc/sysconfig/network-scripts/route-eth0` 文件中，使用以下命令：

```sh
sudo sh -c "ip route > /etc/sysconfig/network-scripts/route-eth0"
```

