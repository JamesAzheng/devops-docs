---
title: "故障通知"
---

# 前言

- 当keepalived的状态发生变化时，可以自动触发脚本的执行，那么就可以通过编写脚本 在发生故障时进行触发 从而起到故障通知的效果

- 默认以用户keepalived身份执行脚本，如果此用户不存在 则以root身份执行

- 可以使用以下的配置来实现指定运行脚本的用户

  - ```ABAP
    global_defs {
    ...
       script_user <USER>
    ...
    }
    ```



# 通知脚本类型

```bash
notify_master <STRING>|<QUOTED-STRING> #当前节点成为主节点时触发的脚本

notify_backup <STRING>|<QUOTED-STRING> #当前节点成为备节点时触发的脚本

notify_fault  <STRING>|<QUOTED-STRING> #当前节点转为"失败"状态时触发的脚本

notify        <STRING>|<QUOTED-STRING> #通用格式的通知触发机制，包含以上三种状态的通知

notify_stop   <STRING>|<QUOTED-STRING> #当停止VRRP时触发的脚本
```



# 脚本的调用方法

- **在 vrrp_instance XXX 语句块末尾添加**

## 范例：

```bash
vrrp_instance WEB1 {
...
    notify_master /etc/keepalived/notify.sh master
    notify_backup /etc/keepalived/notify.sh backup
    notify_fault  /etc/keepalived/notify.sh fault
}
```



# 邮件配置

## 安装邮箱服务

```bash
#Centos
yum -y install mailx

#Ubuntu
apt -y install mailx
```

## 163邮箱

```bash
#vim /etc/mail.rc
...
set from=rootroot25@163.com
set smtp=smtp.163.com
set smtp-auth-user=rootroot25@163.com
set smtp-auth-password=GMZAKJMKZVPKEKAC
set smtp-auth=login
set ssl-verify=ignore
```

## QQ邮箱

```bash
#vim /etc/mail.rc
...
set from=767483070@qq.com
set smtp=smtp.qq.com
set smtp-auth-user=767483070@qq.com
set smtp-auth-password=zcsnweqbmqsybeja
set smtp-auth=login
set ssl-verify=ignore
```

## 测试

```bash
echo "test" |mail -s  "Warning" 767483070@qq.com
```



# 邮件通知脚本范例

```bash
[root@keepalived1 ~]# vim /etc/keepalived/notify.sh

#!/bin/bash
# 
#********************************************************************
#Author:            xiangzheng
#QQ:                767483070
#Date:              2022-02-19
#FileName：         /etc/keepalived/notify.sh
#URL:               https://www.xiangzheng.vip
#Email:             rootroot25@163.com
#Description：      The test script
#Copyright (C):     2022 All rights reserved
#********************************************************************
CONTACT="767483070@qq.com"

notify(){
    MAIL_SUBJECT="keepalived info: VIP floating "
    MAIL_BODY="keepalived VIP floating host:$(hostname) status:${1}"
    echo "${MAIL_BODY}" | mail -s "${MAIL_SUBJECT}" ${CONTACT}
}

case $1 in
master)
    notify master
    ;;
backup)
    notify backup
    ;;
fault)
    notify fault
    ;;
*)
    echo "Usage: $(basename $0) {master|backup|fault}"
    exit 1
    ;;
esac


[root@keepalived1 ~]# chmod +x /etc/keepalived/notify.sh
```

