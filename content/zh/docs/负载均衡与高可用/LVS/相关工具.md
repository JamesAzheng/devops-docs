---
title: "相关工具"
---

# ipvsadm

- 具有管理LVS调度规则 和 对RS的管理等功能

- **LVS 和iptables一样，虽然是内核级别的功能 但也需要用户空间的工具来对其进行管理**

- **来自 ipvsadm 包**

## ipvsadm 相关文件

```bash
[root@lvs-server ~]# rpm -ql ipvsadm
/etc/sysconfig/ipvsadm-config #配置文件
/etc/sysconfig/ipvsadm #ipvs调度规则文件(安装默认没有)
/usr/lib/.build-id
/usr/lib/.build-id/e9
/usr/lib/.build-id/e9/2e0bac9713532c12e56e8290b695eafc6ffb50
/usr/lib/systemd/system/ipvsadm.service #Unit File
/usr/sbin/ipvsadm #主程序
/usr/sbin/ipvsadm-restore #规则重载工具，ipvsadm-restore < 规则配置文件
/usr/sbin/ipvsadm-save #规则保存工具
/usr/share/doc/ipvsadm
/usr/share/doc/ipvsadm/MAINTAINERS
/usr/share/doc/ipvsadm/README
/usr/share/man/man8/ipvsadm-restore.8.gz
/usr/share/man/man8/ipvsadm-save.8.gz
/usr/share/man/man8/ipvsadm.8.gz
```



## ipvsadm 基础使用

### 语法

```bash
ipvsadm -option
```

### 选项

```bash
-Ln #查看现有的规则，n表示不做反向解析

-Lnc #查看连接信息

------------------------------------------------------------------------------------
#管理集群服务
-D -t|u|f service-address #删除
-C #清空
-R #重载,相当于ipvsadm-restore
-S [-n] #保存,相当于ipvsadm-save

------------------------------------------------------------------------------------
#管理集群中的RS
-a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight]  
-d -t|u|f service-address -r server-address
-L|l [options]
-Z [-t|u|f service-address]
```

## 调度规则管理

### 语法

```bash
ipvsadm -A|E -t|u|f service-address [-s scheduler] [-p [timeout]] [-M netmask] [--pe persistence_engine] [-b sched-flags]


#-A|E
-A #增加规则
-E #修改规则

#-t|u|f
-t #tcp协议
-u #udp协议
-f #防火墙标签

#service-address，LVS VIP的地址
VIP的地址:端口号

#[-s scheduler]，注意调度算法要小写
-s #指定调度算法 如：rr、wrr、sh... 不写的话默认为wlc调度算法
```

### 增加规则范例

```bash
# ipvsadm -A -t 192.168.0.18:80 -s rr
# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.0.18:80 rr
```



## RS管理

### 增加规则

```bash
ipvsadm -a|e -t|u|f service-address -r server-address [-g|i|m] [-w weight] 

#-a|e
-a #增加集群中的RS
-e #修改集群中的RS

#-t|u|f
-t #tcp协议
-u #udp协议
-f #

#service-address，VIP的地址
VIP的地址:端口号

#-r server-address
-r RS的IP地址:端口号

# [-g|i|m]，指定工作模型，不指定默认为DR模型
-g #DR
-i #TUN
-m #DNAT


#[-w weight] ，指定权重，不指定则为1
n
```

### 增加规则范例

```bash
[root@lvs-server ~]# ipvsadm -a -t 192.168.0.18:80 -r 10.0.0.28:80 -m
[root@lvs-server ~]# ipvsadm -a -t 192.168.0.18:80 -r 10.0.0.38:80 -m
[root@lvs-server ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  192.168.0.18:80 rr
  -> 10.0.0.28:80                 Masq    1      0          0         
  -> 10.0.0.38:80                 Masq    1      0          0          
```



## LVS 规则持久保存

### 保存

- centos：

```bash
ipvsadm-save > /PATH/TO/IPVSADM_FILE
ipvsadm -S > /PATH/TO/IPVSADM_FILE
systemctl stop ipvsadm.service  #会自动保存规则至/etc/sysconfig/ipvsadm
```

- Ubuntu：

```bash
# ipvsadm-save -n > /etc/ipvsadm.rules

# cat /etc/ipvsadm.rules
-A -t 10.0.0.123:80 -s rr
-a -t 10.0.0.123:80 -r 10.0.0.102:80 -g -w 1
-a -t 10.0.0.123:80 -r 10.0.0.103:80 -g -w 1

# vim /etc/default/ipvsadm
...
AUTO="true"
...
```

### 从规则文件重载

```bash
ipvsadm-restore < /PATH/FROM/IPVSADM_FILE

--------------------------------------------------------------------------

systemctl  start ipvsadm.service  #centos会自动加载/etc/sysconfig/ipvsadm中规则
```

- Ubuntu：

```bash
# ipvsadm-save -n > /etc/ipvsadm.rules

# cat /etc/ipvsadm.rules
-A -t 10.0.0.123:80 -s rr
-a -t 10.0.0.123:80 -r 10.0.0.102:80 -g -w 1
-a -t 10.0.0.123:80 -r 10.0.0.103:80 -g -w 1

#
AUTO="none"
```

