---
title: "è™šæ‹Ÿæœºç½‘ç»œç®¡ç†"
---

- **å®˜æ–¹æ–‡æ¡£ï¼š**https://wiki.libvirt.org/page/VirtualNetworking



# QEMU-KVM ç½‘ç»œæ¦‚è¿°

## æ”¯æŒçš„ç½‘ç»œæ¨¡å¼

- **NAT**
  - æ­¤ä¸ºvirt-installçš„é»˜è®¤æ¨¡å¼ï¼Œä½¿ç”¨çš„æ˜¯IPä¼ªè£… è€Œä¸æ˜¯ SNAT æˆ– DNAT
  - ä½¿ç”¨å®¿ä¸»æœºçš„IPä¸å¤–ç•Œé€šä¿¡ï¼Œä»è€Œå®ç°å®ç°è™šæ‹Ÿæœºè®¿é—®å¤–ç½‘ï¼Œè€Œå¤–ç½‘æ— æ³•è®¿é—®è™šæ‹Ÿæœº
  - æ­¤æ¨¡å¼ä¸‹å¯åŠ¨ä¼šäº§ç”Ÿå¾ˆå¤šiptablesè§„åˆ™ï¼Œè¯·å°å¿ƒã€‚å¦‚æœ iptables è§„åˆ™å‡ºç°é—®é¢˜ï¼Œæ‚¨çš„è™šæ‹Ÿæœºå¯èƒ½ä¼šåœæ­¢æ­£å¸¸é€šä¿¡ã€‚

- **Bridge**
  - è‡ªå®šä¹‰ç½‘æ¡¥æ¨¡å¼

- **ç›´æ¥åˆ†é…ç‰©ç†ç½‘ç»œè®¾å¤‡**
  - åŒ…æ‹¬VT-d å’Œ SR-IOVï¼Œæ€§èƒ½æœ€å¥½

- **è‡ªå®šä¹‰ç½‘ç»œ**

## è™šæ‹Ÿæœºçš„ç½‘å¡è®¾å¤‡

- RTL8139ã€e1000ã€...

- virtio **ç”Ÿäº§ä¸­å¸¸ç”¨ï¼Œæ€§èƒ½æœ€å¥½**

- æŸ¥çœ‹qemu-kvmæ”¯æŒçš„ç½‘å¡å‹å·ï¼š

  - ```bash
    [root@centos-kvm ~]# /usr/libexec/qemu-kvm -net nic,model=?
    Supported NIC models:
    e1000
    e1000e
    rtl8139
    virtio-net-pci
    virtio-net-pci-non-transitional
    virtio-net-pci-transitional
    ```



# ---

# QEMU ä¸ tap è®¾å¤‡

- qemu å¯åŠ¨æ—¶é€šè¿‡ qemu -netdev tap æŒ‡å®š tap è®¾å¤‡

![qemu tun](/docs/è™šæ‹ŸåŒ–/kvm/qemu_tap.png)



å¦‚å›¾ä¸­æ‰€ç¤ºï¼Œçº¢è‰²ç®­å¤´è¡¨ç¤ºæ•°æ®æŠ¥æ–‡çš„å…¥æ–¹å‘ï¼Œæ­¥éª¤ï¼š

1. ç½‘ç»œæ•°æ®ä» Host ä¸Šçš„ç‰©ç†ç½‘å¡æ¥æ”¶ï¼Œåˆ°è¾¾ç½‘æ¡¥ï¼›

2. ç”±äº eth0 ä¸ tap1 å‡åŠ å…¥ç½‘æ¡¥ä¸­ï¼Œæ ¹æ®äºŒå±‚è½¬å‘åŸåˆ™ï¼Œbr0 å°†æ•°æ®ä» tap1 å£è½¬å‘å‡ºå»ï¼Œå³æ•°æ®ç”± Tapè®¾å¤‡æ¥æ”¶ï¼›

3. Tap è®¾å¤‡é€šçŸ¥å¯¹åº”çš„ fd æ•°æ®å¯è¯»ï¼›

4. fd çš„è¯»åŠ¨ä½œé€šè¿‡ tap è®¾å¤‡çš„å­—ç¬¦è®¾å¤‡é©±åŠ¨å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå®Œæˆæ•°æ®æŠ¥æ–‡çš„å‰ç«¯æ¥æ”¶ã€‚
   




# ---



# KVMé»˜è®¤ç½‘ç»œé…ç½®

- **é»˜è®¤ä¸ºNATæ¨¡å¼**ï¼Œç›¸å½“äºwmware workstationçš„NATæ¨¡å¼
- **NATæ¨¡å¼ä¸é€‚ç”¨ä¸ç”Ÿäº§ç¯å¢ƒ**

![è™šæ‹Ÿç½‘ç»œé»˜è®¤ç½‘ç»œæ¦‚è§ˆ.jpg](https://wiki.libvirt.org/images/7/7e/Virtual_network_default_network_overview.jpg)

## DHCP

- é»˜è®¤å®¿ä¸»æœºå®‰è£…äº†dnsmaspåŒ…æ¥æä¾›DHCPæœåŠ¡

```bash
#æŸ¥çœ‹é»˜è®¤å®‰è£…çš„dnsmaspåŒ…
[root@centos-kvm ~]# rpm -q dnsmasq
dnsmasq-2.79-13.el8.x86_64

#é»˜è®¤çš„dnsmaspé…ç½®æ–‡ä»¶ï¼Œç”±libvirtè‡ªåŠ¨åˆ›å»º
[root@centos-kvm ~]# cat /var/lib/libvirt/dnsmasq/default.conf
##WARNING:  THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
##OVERWRITTEN AND LOST.  Changes to this configuration should be made using:
##    virsh net-edit default
## or other application using the libvirt API.
##
## dnsmasq conf file created by libvirt
strict-order
pid-file=/run/libvirt/network/default.pid
except-interface=lo
bind-dynamic
interface=virbr0
dhcp-range=192.168.122.2,192.168.122.254,255.255.255.0 #å¯ä»¥ä¿®æ”¹åœ°å€èŒƒå›´ç­‰ä¿¡æ¯
dhcp-no-override
dhcp-authoritative
dhcp-lease-max=253
dhcp-hostsfile=/var/lib/libvirt/dnsmasq/default.hostsfile
addn-hosts=/var/lib/libvirt/dnsmasq/default.addnhosts
```



## Bridge

- ç›¸å½“äºwmware workstationçš„Vmnet8ç½‘æ¡¥

### è™šæ‹Ÿæœºæœªå¼€å¯æ—¶ç½‘æ¡¥çŠ¶æ€

- æ— ä»»ä½•è™šæ‹Ÿæœºå¼€å¯æ—¶ï¼Œé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ª virbr0 çš„ç½‘æ¡¥ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªvirbr0-nicçš„ç½‘å¡æ¡¥æ¥åˆ°virbr0ç½‘æ¡¥ä¸Š

```bash
#æŸ¥çœ‹ç½‘æ¡¥çŠ¶æ€
[root@centos-kvm ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
virbr0          8000.525400ef6aec       yes             virbr0-nic


#æŸ¥çœ‹å“ªäº›è®¾å¤‡åŠ å…¥åˆ°äº†virbr0ç½‘æ¡¥
[root@centos-kvm ~]# ip link show master virbr0
5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN mode DEFAULT group default qlen 1000
    link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff

#æŸ¥çœ‹æ‰€æœ‰æ¡¥æ¥ç½‘å¡ä¿¡æ¯åŠå¯¹åº”ç½‘æ¡¥
[root@centos-kvm ~]# bridge link show
5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 master virbr0 state disabled priority 32 cost 100

# ip a
...
4: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff
```

#### å›¾è§£

![image-20220405235132067](/docs/è™šæ‹ŸåŒ–/kvm/image-20220405235132067.png)



### è™šæ‹Ÿæœºå¼€å¯åç½‘æ¡¥çŠ¶æ€

- å¼€å¯è™šæ‹Ÿæœºåï¼Œä¼šæŒ‰ç…§é¡ºåºä¾æ¬¡ç”Ÿæˆvnet0(1ã€2ã€3...) çš„ä¸´æ—¶è™šæ‹Ÿç½‘å¡ï¼ŒåŒæ ·æ¡¥æ¥åˆ°virbr0çš„ç½‘æ¡¥ä¸Š

```bash
#æŸ¥çœ‹ç½‘æ¡¥çŠ¶æ€
[root@centos-kvm ~]# brctl show
bridge name     bridge id               STP enabled     interfaces
virbr0          8000.525400ef6aec       yes             virbr0-nic
                                                        vnet0

#æŸ¥çœ‹virbr0ç½‘æ¡¥çš„ç½‘ç»œçŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°virbr0-nic å’Œ vnet0è¿™ä¸¤å—ç½‘å¡ä»¥åŠæ¡¥æ¥åˆ°virbr0ç½‘æ¡¥ä¸Šäº†
[root@centos-kvm ~]# ip link show master virbr0
5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN mode DEFAULT group default qlen 1000
    link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff
8: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr0 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:aa:fc:1c brd ff:ff:ff:ff:ff:ff

#æŸ¥çœ‹æ‰€æœ‰æ¡¥æ¥ç½‘å¡ä¿¡æ¯åŠå¯¹åº”ç½‘æ¡¥
[root@centos-kvm ~]# bridge link show
5: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 master virbr0 state disabled priority 32 cost 100
8: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master virbr0 state forwarding priority 32 cost 100
```

#### å›¾è§£

![image-20220406000007959](/docs/è™šæ‹ŸåŒ–/kvm/image-20220406000007959.png)

## iptables

- ä»¥ä¸‹è§„åˆ™ç”±libvirtdæœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œä»è€Œå®ç°SNATï¼Œå³å†…ç½‘è®¿é—®å¤–ç½‘ï¼Œè€Œå¤–ç½‘æ— æ³•è®¿é—®å†…ç½‘

```bash
[root@centos-kvm ~]# iptables -vnL -t nat
...
Chain LIBVIRT_PRT (1 references)
 pkts bytes target     prot opt in     out     source               destination
    0     0 RETURN     all  --  *      *       192.168.122.0/24     224.0.0.0/24
    0     0 RETURN     all  --  *      *       192.168.122.0/24     255.255.255.255
    0     0 MASQUERADE  tcp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535
    0     0 MASQUERADE  udp  --  *      *       192.168.122.0/24    !192.168.122.0/24     masq ports: 1024-65535
    0     0 MASQUERADE  all  --  *      *       192.168.122.0/24    !192.168.122.0/24
```



## é»˜è®¤è™šæ‹Ÿæœºä¸å¤–ç•Œé€šä¿¡

### ç¯å¢ƒ

#### KVM1

- å®¿ä¸»æœºï¼š

  - eth0ï¼š10.0.0.8 VMnet8 NAT

- è™šæ‹Ÿæœºï¼š

  - ```bash
    [root@centos-kvm1 ~]# virsh list
     Id   Name      State
    -------------------------
     1    centos7   running
    
    [root@centos-kvm1 ~]# virsh domiflist centos7
     Interface   Type      Source    Model    MAC
    -------------------------------------------------------------
     vnet0       network   default   virtio   52:54:00:aa:fc:1c
    
    [root@centos-kvm1 ~]# virsh domifaddr centos7
     Name       MAC address          Protocol     Address
    -------------------------------------------------------------------------------
     vnet0      52:54:00:aa:fc:1c    ipv4         192.168.122.208/24
    
    [root@centos-kvm1 ~]# ip a
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
        link/ether 00:0c:29:0b:14:8b brd ff:ff:ff:ff:ff:ff
        inet 10.0.0.8/16 brd 10.0.255.255 scope global noprefixroute eth0
           valid_lft forever preferred_lft forever
        inet6 fe80::20c:29ff:fe0b:148b/64 scope link 
           valid_lft forever preferred_lft forever
    3: virbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
        link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff
        inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
           valid_lft forever preferred_lft forever
    4: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc fq_codel master virbr0 state DOWN group default qlen 1000
        link/ether 52:54:00:ef:6a:ec brd ff:ff:ff:ff:ff:ff
    6: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr0 state UNKNOWN group default qlen 1000
        link/ether fe:54:00:aa:fc:1c brd ff:ff:ff:ff:ff:ff
        inet6 fe80::fc54:ff:feaa:fc1c/64 scope link 
           valid_lft forever preferred_lft forever
    
    [root@centos-kvm1 ~]# brctl show
    bridge name	bridge id		STP enabled	interfaces
    virbr0		8000.525400ef6aec	yes		virbr0-nic #virbr0-nicè¡¨ç¤ºvirbr0çš„ç½‘å¡
    							            vnet0						         
    ```

#### KVM2

- å®¿ä¸»æœºï¼š
  - eth0ï¼š10.0.0.18 VMnet8 NAT

- è™šæ‹Ÿæœºï¼š

  - ```bash
    [root@centos-kvm2 ~]# virsh list
     Id   Name      State
    -------------------------
     1    centos7   running
    
    [root@centos-kvm2 ~]# virsh domiflist centos7
     Interface   Type      Source    Model    MAC
    -------------------------------------------------------------
     vnet0       network   default   virtio   52:54:00:7e:e2:fd
     
    [root@centos-kvm2 ~]# virsh domifaddr centos7
     Name       MAC address          Protocol     Address
    -------------------------------------------------------------------------------
     vnet0      52:54:00:7e:e2:fd    ipv4         192.168.122.211/24
     
    [root@centos-kvm2 ~]# ip a
    1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
        link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
        inet 127.0.0.1/8 scope host lo
           valid_lft forever preferred_lft forever
        inet6 ::1/128 scope host 
           valid_lft forever preferred_lft forever
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
        link/ether 00:0c:29:d0:8e:57 brd ff:ff:ff:ff:ff:ff
        inet 10.0.0.18/16 brd 10.0.255.255 scope global noprefixroute eth0
           valid_lft forever preferred_lft forever
        inet6 fe80::20c:29ff:fed0:8e57/64 scope link 
           valid_lft forever preferred_lft forever
    3: virbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
        link/ether 52:54:00:ff:56:99 brd ff:ff:ff:ff:ff:ff
        inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
           valid_lft forever preferred_lft forever
    4: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master virbr0 state UNKNOWN group default qlen 1000
        link/ether fe:54:00:7e:e2:fd brd ff:ff:ff:ff:ff:ff
        inet6 fe80::fc54:ff:fe7e:e2fd/64 scope link 
           valid_lft forever preferred_lft forever
           
    [root@centos-kvm2 ~]# brctl show
    bridge name	bridge id		STP enabled	interfaces
    virbr0		8000.525400ff5699	yes		vnet0
    ```

### ä¸äº’è”ç½‘é€šä¿¡

- ç»“è®ºï¼š
  - è™šæ‹Ÿæœºå¯ä»¥pingé€šäº’è”ç½‘ï¼Œå› ä¸ºè™šæ‹Ÿæœºèµ°çš„æ˜¯SNAT
- å·¥ä½œè¿‡ç¨‹ï¼š
  - å½“è™šæ‹Ÿæœºå¯åŠ¨åï¼Œé™¤è™šæ‹Ÿæœºè‡ªèº«ä¼šç”Ÿæˆeth0ç½‘å¡å¤–ï¼Œè¿˜ä¼šåœ¨å®¿ä¸»æœºç”Ÿæˆä¸€å—vnet0çš„ç½‘å¡ï¼Œè€Œå®¿ä¸»æœºç”Ÿæˆçš„vnet0ç½‘å¡éƒ½æ˜¯æ¡¥æ¥åœ¨virbr0è¿™ä¸ªç½‘æ¡¥ä¸Šçš„ï¼Œè™šæ‹Ÿæœºçš„æŠ¥æ–‡ä¼šé€šè¿‡å®¿ä¸»æœºçš„DNATè½¬æ¢ ä¹Ÿå°±æ˜¯æ‰€è°“çš„ Address Masquerading åœ°å€ä¼ªè£…å‡ºå»çš„
  - **æ¡¥æ¥ç½‘å¡çš„IPå¯ä»¥ç›´æ¥è®¿é—®**
- æŠ¥æ–‡æµå‘ï¼š
  - è™šæ‹Ÿæœºeth0 **<-->** å®¿ä¸»æœºvnet0 **<-->** å®¿ä¸»æœºvirbr0 **<-->** å®¿ä¸»æœºiptables **<-->** å®¿ä¸»æœºeth0 **<-->** internet
- ç®€è¿°ï¼š
  - å°±ç›¸å½“äºå®¿ä¸»æœºè‡ªèº«è®¿é—®äº’è”ç½‘

#### èŒƒä¾‹

```bash
#ç™»å½•åˆ°è™šæ‹Ÿæœº
[root@centos-kvm1 ~]# ssh 192.168.122.208
root@192.168.122.208's password: 
Last login: Wed Apr  6 18:40:02 2022 from 10.0.0.201

#è®¿é—®äº’è”ç½‘
[root@localhost ~]# ping www.baidu.com
PING www.a.shifen.com (36.152.44.96) 56(84) bytes of data.
64 bytes from 36.152.44.96 (36.152.44.96): icmp_seq=1 ttl=127 time=43.0 ms
...
```

### ä¸å…¶ä»–å®¿ä¸»æœºé€šä¿¡

- ç»“è®ºï¼š
  - è™šæ‹Ÿæœºå¯ä»¥ä¸å…¶ä»–å®¿ä¸»æœºé€šä¿¡ï¼Œå› ä¸ºè™šæ‹Ÿæœºèµ°çš„æ˜¯SNAT
- å·¥ä½œè¿‡ç¨‹ï¼š
  - å½“è™šæ‹Ÿæœºå¯åŠ¨åï¼Œé™¤è™šæ‹Ÿæœºè‡ªèº«ä¼šç”Ÿæˆeth0ç½‘å¡å¤–ï¼Œè¿˜ä¼šåœ¨å®¿ä¸»æœºç”Ÿæˆä¸€å—vnet0çš„ç½‘å¡ï¼Œè€Œå®¿ä¸»æœºç”Ÿæˆçš„vnet0ç½‘å¡éƒ½æ˜¯æ¡¥æ¥åœ¨virbr0è¿™ä¸ªç½‘æ¡¥ä¸Šçš„ï¼Œè™šæ‹Ÿæœºçš„æŠ¥æ–‡ä¼šé€šè¿‡å®¿ä¸»æœºçš„DNATè½¬æ¢ ä¹Ÿå°±æ˜¯æ‰€è°“çš„ Address Masquerading åœ°å€ä¼ªè£…å‡ºå»çš„
- æŠ¥æ–‡æµå‘ï¼š
  - è™šæ‹Ÿæœºeth0 **<-->** å®¿ä¸»æœºvnet0 **<-->** å®¿ä¸»æœºiptables **<-->** å®¿ä¸»æœºeth0 **<-->** internet
- ç®€è¿°ï¼š
  - å°±ç›¸å½“äºå®¿ä¸»æœºè‡ªèº«è®¿é—®å…¶ä»–å®¿ä¸»æœº

#### èŒƒä¾‹

```bash
#ç™»å½•åˆ°è™šæ‹Ÿæœº
[root@centos-kvm1 ~]# ssh 192.168.122.208
root@192.168.122.208's password: 
Last login: Wed Apr  6 18:40:02 2022 from 10.0.0.201

#è®¿é—®å…¶ä»–å®¿ä¸»æœº
[root@localhost ~]# ping 10.0.0.18
PING 10.0.0.18 (10.0.0.18) 56(84) bytes of data.
64 bytes from 10.0.0.18: icmp_seq=1 ttl=64 time=2.15 ms
...

#å…¶ä»–å®¿ä¸»æœºæŠ“åŒ…
[root@centos-kvm2 ~]# tcpdump -nn icmp
...
16:18:50.914048 IP 10.0.0.8 > 10.0.0.18: ICMP echo request, id 3195, seq 1, length 64
16:18:50.914175 IP 10.0.0.18 > 10.0.0.8: ICMP echo reply, id 3195, seq 1, length 64
...
```

### ä¸å…¶ä»–å®¿ä¸»æœºä¸­çš„è™šæ‹Ÿæœºè¿›è¡Œé€šä¿¡

- ç»“è®ºï¼š
  - **æ— æ³•é€šä¿¡ï¼Œå› ä¸ºéƒ½åœ¨å„è‡ªçš„NATç½‘ç»œä¸­**


#### èŒƒä¾‹

```bash
[root@centos-kvm1 ~]# ping -c1 192.168.122.211
PING 192.168.122.211 (192.168.122.211) 56(84) bytes of data.
From 192.168.122.1 icmp_seq=1 Destination Host Unreachable

--- 192.168.122.211 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
```



## é»˜è®¤å¤–ç•Œä¸è™šæ‹Ÿæœºé€šä¿¡

### ç¯å¢ƒ

- å‚é˜…ä¸Šæ–‡

```bash
#å¤–éƒ¨ä¸»æœºæ— æ³•è®¿é—®è™šæ‹Ÿæœºï¼Œå› ä¸ºè™šæ‹Ÿæœºèµ°çš„æ˜¯SNAT
C:\Users\é˜¿å¾>ping 192.168.122.208

æ­£åœ¨ Ping 192.168.122.208 å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:
è¯·æ±‚è¶…æ—¶ã€‚

192.168.122.208 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:
    æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 0ï¼Œä¸¢å¤± = 4 (100% ä¸¢å¤±)ï¼Œ
```



# ---



# KVMç½‘ç»œç®¡ç†ç›¸å…³å‘½ä»¤

- **ä»¥ä¸‹å‘½ä»¤å…¨éƒ¨éƒ½åœ¨å®¿ä¸»æœºæ‰§è¡Œ**
- ç›¸å…³ä¿¡æ¯å…¶å®å°±æ˜¯è°ƒç”¨äº†æ­¤æ–‡ä»¶ä¸­çš„å†…å®¹ï¼š/etc/libvirt/qemu/centos7.xml

### æŸ¥çœ‹è™šæ‹Ÿæœºçš„ç½‘å¡é…ç½®

```bash
#é»˜è®¤NATç½‘ç»œ
# virsh domiflist centos7
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 -           network   default   virtio   52:54:00:aa:fc:1c
 
#æ¡¥æ¥åˆ°å®¿ä¸»æœºeth0
# virsh domiflist centos7
 Interface   Type     Source   Model    MAC
-----------------------------------------------------------
 macvtap0    direct   eth0     virtio   52:54:00:aa:fc:1c
```

### æŸ¥çœ‹è™šæ‹Ÿæœºçš„ç½‘å¡åœ°å€ä¿¡æ¯

- éœ€è¦è™šæ‹Ÿæœºå¼€å¯ï¼Œå¦åˆ™å°†æ— æ³•è·å–è™šæ‹Ÿæœºçš„IPåœ°å€

```bash
# virsh domifaddr centos7-3
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet0      52:54:00:23:d4:db    ipv4         192.168.122.63/24
```

### æŸ¥çœ‹è™šæ‹ŸæœºæŒ‡å®šç½‘å¡çš„çŠ¶æ€

```bash
# virsh domifstat centos7-3 --interface vnet0
vnet0 rx_bytes 20302 #æ¥å—çš„å­—èŠ‚å¤§å°
vnet0 rx_packets 326
vnet0 rx_errs 0
vnet0 rx_drop 0
vnet0 tx_bytes 6851 #å‘é€çš„å­—èŠ‚å¤§å°
vnet0 tx_packets 84
vnet0 tx_errs 0
vnet0 tx_drop 0
```

### åˆ—å‡ºç›®å‰å·²æœ‰çš„ç½‘ç»œ

```bash
# virsh net-list
 Name      State    Autostart   Persistent
--------------------------------------------
 default   active   yes         yes
```

### åˆ—å‡ºæŒ‡å®šç½‘ç»œçš„è¯¦ç»†é…ç½®

- ä¸‹é¢ä»¥æŸ¥çœ‹é»˜è®¤çš„defaultç½‘ç»œè¯¦ç»†ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯natç½‘ç»œæ¨¡å¼ï¼‰

```bash
# virsh net-dumpxml default
<network>
  <name>default</name>
  <uuid>1064e2fe-d78e-4690-84a1-9f043b84b643</uuid>
  <forward mode='nat'>
    <nat>
      <port start='1024' end='65535'/>
    </nat>
  </forward>
  <bridge name='virbr0' stp='on' delay='0'/>
  <mac address='52:54:00:ef:6a:ec'/>
  <ip address='192.168.122.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.122.2' end='192.168.122.254'/>
    </dhcp>
  </ip>
</network>
```

#### æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨æ­¤æ–‡ä»¶çš„å†…å®¹

```bash
# cat /etc/libvirt/qemu/networks/default.xml
<!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh net-edit default
or other application using the libvirt API.
-->

<network>
  <name>default</name>
  <uuid>1064e2fe-d78e-4690-84a1-9f043b84b643</uuid>
  <forward mode='nat'/>
  <bridge name='virbr0' stp='on' delay='0'/>
  <mac address='52:54:00:ef:6a:ec'/>
  <ip address='192.168.122.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.122.2' end='192.168.122.254'/>
    </dhcp>
  </ip>
</network>
```





# ---

# å°†è™šæ‹Ÿç½‘ç»œæµé‡é™åˆ¶åˆ°ç‰¹å®šæ¥å£

- è™šæ‹Ÿç½‘ç»œå¯ä»¥è¿æ¥åˆ°ç‰©ç†ç½‘ç»œã€‚å®ƒçš„æµé‡è¿˜å¯ä»¥è¢«é™åˆ¶ä¸ºä½¿ç”¨ç‰¹å®šæ¥å£
- ä¾‹å¦‚åœ¨å…·æœ‰ eth0/1/2 çš„ç³»ç»Ÿä¸Šï¼Œå¯ä»¥é™åˆ¶è™šæ‹Ÿç½‘ç»œä»…ä½¿ç”¨ eth0
- ä½†æ˜¯ï¼Œè¿™**åªåœ¨è·¯ç”±å’Œ nat æ¨¡å¼ä¸‹æ‰æœ‰æ„ä¹‰**
- åœ¨åˆ›å»ºæ–°çš„è™šæ‹Ÿç½‘ç»œæ—¶ï¼Œ**å¯ä»¥åœ¨ XMLï¼ˆdev="" å±æ€§ï¼‰æˆ– virt-manager ä¸­å®šä¹‰é™åˆ¶**



# ---

# å®ç° è™šæ‹Ÿæœºç½‘å¡æ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡

- å› ä¸ºé»˜è®¤è™šæ‹Ÿæœºçš„ç½‘å¡æ˜¯æ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ virbr0 ç½‘æ¡¥ï¼Œè€Œ virbr0 ç½‘æ¡¥æ˜¯æ— æ³•å’Œå…¶ä»–å®¿ä¸»æœºé—´è¿›è¡Œé€šä¿¡çš„
- è€Œå°†è™šæ‹Ÿæœºç½‘å¡æ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç‰©ç†ç½‘å¡åï¼Œåªè¦å®¿ä¸»æœºèƒ½ä¸å…¶ä»–çš„è™šæ‹Ÿæœºçš„å®¿ä¸»æœºè¿›è¡Œé€šä¿¡ï¼Œé‚£ä¹ˆå°±**å¯ä»¥å®ç°è·¨å®¿ä¸»æœºçš„è™šæ‹Ÿæœºä¸è™šæ‹Ÿæœºä¹‹é—´çš„é€šä¿¡**
- **ç›¸å½“äº wmware workstation ä¸­çš„ Vmnet0**

## å›¾è§£

...

## å®ç°

- æ‰€æœ‰è™šæ‹Ÿæœºçš„å®¿ä¸»æœºéƒ½æ‰§è¡Œï¼š

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

- é€‰æ‹©ä¸€ä¸ªè™šæ‹Ÿæœºç„¶ååŒå‡»
- ç‚¹å‡»ğŸ’¡
- NIC :xx:xx:xx **-->** Details
  - Network source
    - Host device eth0: macvtap
  - Source mode
    - Bridge
  - Device mode
    - virtio
  - Apply

## å®ç°å

```bash
# virsh domiflist centos7
 Interface   Type     Source   Model    MAC
-----------------------------------------------------------
 macvtap0    direct   eth0     virtio   52:54:00:aa:fc:1c
```

## æµ‹è¯•



## é—®é¢˜

- å®¿ä¸»æœºæ— æ³•sshåˆ°è™šæ‹Ÿæœºï¼Œä½†åœ¨windowså¯ä»¥pingé€šï¼Ÿï¼Ÿï¼Ÿ
- å¦å¤–ä¸€å°ä¸»æœºåœ¨æ·»åŠ çš„æ—¶å€™ä¸ºä»€ä¹ˆæ²¡æœ‰ Host device eth0: macvtap è¿™ä¸ªé€‰é¡¹ï¼Ÿï¼Ÿï¼Ÿ










# ---

# å®ç° åŸºäºè‡ªå®šä¹‰ç½‘æ¡¥çš„è™šæ‹Ÿç½‘ç»œ

## åŸç†

- å°†å®¿ä¸»æœºçš„eth0ç½‘å¡ å’Œ å®¿ä¸»æœºçš„eth0ç½‘å¡ éƒ½æ¡¥æ¥åˆ° è‡ªå®šä¹‰çš„ç½‘æ¡¥ä¸Šï¼Œä»è€Œå®ç°è·¨å®¿ä¸»æœºçš„è™šæ‹Ÿæœºé—´é€šä¿¡

## åˆ›å»ºè‡ªå®šä¹‰ç½‘æ¡¥

- æ‰€æœ‰å®¿ä¸»æœºéƒ½è¿›è¡Œæ­¤æ“ä½œ

### centos

#### å†™é…ç½®æ–‡ä»¶åˆ›å»º

- **æ³¨æ„ï¼šå†™é™æ€æ–‡ä»¶æœ‰æ—¶å€™åŠ è½½é…ç½®æ–‡ä»¶åä¹Ÿä¼šæ— æ³•è¿æ¥åˆ°å®¿ä¸»æœºï¼Ÿï¼Ÿï¼Ÿï¼Œè§£å†³æ–¹æ³•ï¼Ÿï¼Ÿï¼Ÿ**

##### åˆå§‹çŠ¶æ€

```bash
# nmcli connection 
NAME    UUID                                  TYPE      DEVICE 
eth0    5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03  ethernet  eth0   
virbr0  de813b16-d55d-4983-82cd-82fb7d44aa17  bridge    virbr0 
```

##### å†™é…ç½®æ–‡ä»¶åˆ›å»º

```bash
# cat /etc/sysconfig/network-scripts/ifcfg-virbr1
TYPE=Bridge
NAME=virbr1
DEVICE=virbr1
STP=yes
BOOTPROTO=none
IPADDR=10.0.0.88
PREFIX=24
GATEWAY=10.0.0.2
ONBOOT=yes
DNS1=180.76.76.76
DNS2=223.5.5.5
```

##### ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ

```bash
# nmcli connection reload 
# nmcli connection up virbr1 
Connection successfully activated (master waiting for slaves) (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/10)

# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.2        0.0.0.0         UG    100    0        0 eth0
0.0.0.0         10.0.0.2        0.0.0.0         UG    426    0        0 virbr1
10.0.0.0        0.0.0.0         255.255.255.0   U     101    0        0 eth0
10.0.0.0        0.0.0.0         255.255.255.0   U     426    0        0 virbr1
10.0.0.0        0.0.0.0         255.255.0.0     U     100    0        0 eth0
192.168.122.0   0.0.0.0         255.255.255.0   U     425    0        0 virbr0

# nmcli connection 
NAME    UUID                                  TYPE      DEVICE 
eth0    5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03  ethernet  eth0   
virbr0  9bab7bc4-8462-4013-a378-1f65274045a3  bridge    virbr0 
virbr1  282db82c-a36d-fb08-d7a9-78ef62fac87e  bridge    virbr1 

# ip link show master virbr1
ç©º

# bridge link show
ç©º
```

##### å°†eth0ç½‘å¡åŠ å…¥åˆ°è‡ªå®šä¹‰ç½‘æ¡¥

- å†™é…ç½®æ–‡ä»¶ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ

```bash
# cat /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
DEVICE=eth0
NAME=eth0
ONBOOT=yes
BRIDGE=virbr1
```

- å‘½ä»¤è¡Œæ·»åŠ ï¼Œä¸´æ—¶ç”Ÿæ•ˆ

```bash
# brctl addif virbr1 eth0

#ä½¿å…¶ç”Ÿæ•ˆ
# nmcli connection reload 
# nmcli connection up eth0 
```

##### ç™»å½•æµ‹è¯•

```bash
# ssh 10.0.0.88
The authenticity of host '10.0.0.88 (10.0.0.88)' can't be established.
ECDSA key fingerprint is SHA256:LMMMtet8FFLvX4xwl2ykQhhB/5ffCO6zMiwn5OsNRXg.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.0.0.88' (ECDSA) to the list of known hosts.
root@10.0.0.88's password:

# nmcli connection 
NAME    UUID                                  TYPE      DEVICE 
virbr1  282db82c-a36d-fb08-d7a9-78ef62fac87e  bridge    virbr1 
virbr0  9bab7bc4-8462-4013-a378-1f65274045a3  bridge    virbr0 
eth0    5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03  ethernet  eth0

# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.0.2        0.0.0.0         UG    426    0        0 virbr1
10.0.0.0        0.0.0.0         255.255.255.0   U     426    0        0 virbr1
192.168.122.0   0.0.0.0         255.255.255.0   U     425    0        0 virbr0

# ip link show master virbr1
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr1 state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:d0:8e:57 brd ff:ff:ff:ff:ff:ff

# bridge link show
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master virbr1 state forwarding priority 32 cost 100 


# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr1 state UP group default qlen 1000
    link/ether 00:0c:29:d0:8e:57 brd ff:ff:ff:ff:ff:ff
3: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:fe:17:91 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
9: virbr1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:d0:8e:57 brd ff:ff:ff:ff:ff:ff
    inet 10.0.0.88/24 brd 10.0.0.255 scope global noprefixroute virbr1
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fed0:8e57/64 scope link 
       valid_lft forever preferred_lft forever
```

#### é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º

- **æ³¨æ„ï¼šé€šè¿‡å‘½ä»¤åˆ›å»ºç½‘æ¡¥è€Œç”Ÿæˆçš„æ–‡ä»¶ä¸€èˆ¬åç»­è¿˜è¦åŠ ä»¥ä¿®æ”¹**
- **æ­¤æ–¹å¼æœ‰é—®é¢˜**
- åˆå§‹çŠ¶æ€

```bash
[root@centos-kvm2 ~]# nmcli connection 
NAME    UUID                                  TYPE      DEVICE 
eth0    5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03  ethernet  eth0   
virbr0  9bab7bc4-8462-4013-a378-1f65274045a3  bridge    virbr0 
```

- é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º
- **æ³¨æ„ï¼šé€šè¿‡å‘½ä»¤åˆ›å»ºçš„ç½‘æ¡¥ åˆ›å»ºåä¼šè‡ªåŠ¨å¯åŠ¨ ä¸‹é¢å‘½ä»¤æ‰§è¡Œåä¼šå’Œå®¿ä¸»æœºæ–­å¼€è¿æ¥ ä¸”æ— æ³•è¿æ¥(ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ)ï¼Œé™¤éå°†virbr1è¿™ä¸ªç½‘æ¡¥downæ‰ï¼Œæ‰€ä»¥æœ€å¥½è¿˜æ˜¯é€šè¿‡å†™é…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ›å»º**

```bash
[root@centos-kvm2 ~]# nmcli connection add con-name virbr1 type bridge ifname virbr1 ipv4.method manual ipv4.addresses 10.0.0.88/24 ipv4.gateway 10.0.0.2
Connection 'virbr1' (b1aa3849-e990-465a-b300-08d5e91e6da3) successfully added.
```

- åˆ›å»ºåç”Ÿæˆçš„æ–‡ä»¶

```bash
[root@centos-kvm2 ~]# cat /etc/sysconfig/network-scripts/ifcfg-virbr1 
STP=yes
BRIDGING_OPTS=priority=32768
TYPE=Bridge
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
IPADDR=10.0.0.88
PREFIX=24
GATEWAY=10.0.0.2
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=virbr1
UUID=2f95f5ad-a549-4262-96ef-2201236ee920
DEVICE=virbr1
ONBOOT=yes
```

- åˆ›å»ºåç”Ÿæˆçš„è§„åˆ™
- **ç„¶åå°±æ— æ³•sshè¿æ¥åˆ°å®¿ä¸»æœºäº†**

```bash
[root@centos-kvm2 ~]# nmcli connection show 
NAME    UUID                                  TYPE      DEVICE 
eth0    5fb06bd0-0bb0-7ffb-45f1-d6edd65f3e03  ethernet  eth0   
virbr0  9bab7bc4-8462-4013-a378-1f65274045a3  bridge    virbr0 
virbr1  2f95f5ad-a549-4262-96ef-2201236ee920  bridge    virbr1     
```

### ubuntu

#### å†™é…ç½®æ–‡ä»¶åˆ›å»º

- å‚é˜…pdfæˆ–è‡ªå†™ç¬”è®°



## é€šè¿‡virt-managerä¿®æ”¹åŸæœ‰è™šæ‹Ÿæœºé…ç½®æµ‹è¯•

### ä¿®æ”¹å‰ç¯å¢ƒ

```bash
#kvm1
[root@centos-kvm1 ~]# virsh domiflist centos7 
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 vnet0       network   default   virtio   52:54:00:aa:fc:1c
[root@centos-kvm1 ~]# virsh domifaddr centos7
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet0      52:54:00:aa:fc:1c    ipv4         192.168.122.208/24


#kvm2
[root@centos-kvm2 ~]# virsh domiflist centos7 
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 vnet0       network   default   virtio   52:54:00:7e:e2:fd
[root@centos-kvm2 ~]# virsh domifaddr centos7 
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet0      52:54:00:7e:e2:fd    ipv4         192.168.122.211/24
```

### ä¿®æ”¹

- æ‰€æœ‰è™šæ‹Ÿæœºçš„å®¿ä¸»æœºéƒ½æ‰§è¡Œï¼š

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

- é€‰æ‹©ä¸€ä¸ªè™šæ‹Ÿæœºç„¶ååŒå‡»
- ç‚¹å‡»ğŸ’¡
- NIC :xx:xx:xx **-->** Details
  - Network source
    - Bridge device ...
    - Device nameï¼švirbr1
  - Source mode
    - Bridge
  - Device mode
    - virtio
  - Apply
- é‡å¯è™šæ‹Ÿæœºï¼Œé‡å¯åå› ä¸ºæ˜¯ä¸å®¿ä¸»æœºçš„eth0ç½‘å¡å…±åŒæ¡¥æ¥åœ¨virbr1ç½‘æ¡¥ä¸Šï¼Œæ‰€ä»¥ä¼šä½¿ç”¨wmnet8ä¹Ÿå°±æ˜¯NATç½‘å¡çš„DHCPæœåŠ¡è·å–IPåœ°å€

### ä¿®æ”¹åç¯å¢ƒ

```bash
#kvm1
[root@centos-kvm1 ~]# virsh domiflist centos7 
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 vnet0       network   default   virtio   52:54:00:aa:fc:1c
[root@centos-kvm1 ~]# virsh domifaddr centos7
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
éœ€è¦è¿›å…¥åˆ°è™šæ‹ŸæœºæŸ¥çœ‹ï¼Œè¿™é‡Œçœ‹ä¸åˆ°ï¼Œè¿™é‡Œè·å–çš„åœ°å€æ˜¯10.0.0.208
å› ä¸ºæ˜¯ä¸å®¿ä¸»æœºçš„eth0ç½‘å¡å…±åŒæ¡¥æ¥åœ¨virbr1ç½‘æ¡¥ä¸Šï¼Œæ‰€ä»¥ä¼šä½¿ç”¨wmnet8ä¹Ÿå°±æ˜¯NATç½‘å¡çš„DHCPæœåŠ¡è·å–IPåœ°å€


#kvm2
[root@centos-kvm2 ~]# virsh domiflist centos7 
 Interface   Type     Source   Model    MAC
-----------------------------------------------------------
 vnet0       bridge   virbr1   virtio   52:54:00:7e:e2:fd

[root@centos-kvm2 ~]# virsh domifaddr centos7
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
éœ€è¦è¿›å…¥åˆ°è™šæ‹ŸæœºæŸ¥çœ‹ï¼Œè¿™é‡Œçœ‹ä¸åˆ°ï¼Œè¿™é‡Œè·å–çš„åœ°å€æ˜¯10.0.0.210
å› ä¸ºæ˜¯ä¸å®¿ä¸»æœºçš„eth0ç½‘å¡å…±åŒæ¡¥æ¥åœ¨virbr1ç½‘æ¡¥ä¸Šï¼Œæ‰€ä»¥ä¼šä½¿ç”¨wmnet8ä¹Ÿå°±æ˜¯NATç½‘å¡çš„DHCPæœåŠ¡è·å–IPåœ°å€
```

### ä¿®æ”¹åå®¿ä¸»æœºçš„å˜åŒ–

- å¼€å¯çš„è™šæ‹Ÿæœºåœ¨å®¿ä¸»æœºç”Ÿæˆvnet0 ç½‘å¡ï¼Œè€Œvnet0åˆæ¡¥æ¥åˆ°virbr1ç½‘æ¡¥ä¸Š

```bash
[root@centos-kvm1 ~]# ip link show master virbr1
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr1 state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:0b:14:8b brd ff:ff:ff:ff:ff:ff
5: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr1 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:aa:fc:1c brd ff:ff:ff:ff:ff:ff


[root@centos-kvm2 ~]# ip link show master virbr1
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel master virbr1 state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:d0:8e:57 brd ff:ff:ff:ff:ff:ff
10: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue master virbr1 state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether fe:54:00:7e:e2:fd brd ff:ff:ff:ff:ff:ff
```



### æµ‹è¯•

```bash
[root@localhost ~]# ping 10.0.0.210
...
64 bytes from 10.0.0.210: icmp_seq=1 ttl=64 time=4.12 ms
...

[root@localhost2 ~]# ping 10.0.0.208
...
64 bytes from 10.0.0.208: icmp_seq=1 ttl=64 time=1.97 ms
...

------------------------------------------------------------------------------

[root@localhost ~]# ping www.baidu.com
...
64 bytes from 36.152.44.95 (36.152.44.95): icmp_seq=1 ttl=128 time=41.1 ms
...
[root@localhost2 ~]# ping www.baidu.com
...
64 bytes from 36.152.44.95 (36.152.44.95): icmp_seq=1 ttl=128 time=42.8 ms
...

------------------------------------------------------------------------------

[root@localhost ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search localdomain
nameserver 10.0.0.2

[root@localhost2 ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search localdomain
nameserver 10.0.0.2

```

### æœ¬è´¨ä¸Šå˜åŒ–çš„å†…å®¹

```bash
#ä¿®æ”¹å‰
# /etc/libvirt/qemu/centos7.xml
...
    <interface type='network'>
      <mac address='52:54:00:aa:fc:1c'/>
      <source network='default'/>
...

#ä¿®æ”¹å
# /etc/libvirt/qemu/centos7.xml
...
    <interface type='bridge'>
      <mac address='52:54:00:aa:fc:1c'/>
      <source bridge='virbr1'/>
...
```



## åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºæµ‹è¯•

- åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºæ—¶æŒ‡å®šæ¡¥æ¥ç½‘ç»œ

- PXEå®ç°å‡†å¤‡è¿‡ç¨‹å‚é˜… KVM pdf æˆ– OS installç¬”è®°
- **æ³¨æ„ï¼šksæ–‡ä»¶çš„è™šæ‹Ÿç£ç›˜è¦æ”¹ä¸ºvda**

```bash
#åˆ›å»ºè™šæ‹Ÿç£ç›˜
qemu-img create -f qcow2 /var/lib/libvirt/images/centos7-pxe.qcow2 200G

#åˆ›å»ºè‡ªå®šä¹‰ç½‘æ¡¥çš„è™šæ‹Ÿæœº
virt-install --virt-type kvm --name centos7 --memory 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos7-pxe.qcow2 --graphics vnc,listen=0.0.0.0 --network=bridge:virbr1,model=virtio --pxe
```

- ...





# ---

# å®ç° ç”¨æˆ·è‡ªå®šä¹‰çš„éš”ç¦»çš„è™šæ‹Ÿç½‘ç»œ

- å³è™šæ‹Ÿæœºçš„ç½‘å¡æ¡¥æ¥åˆ°å®¿ä¸»æœºçš„ç½‘æ¡¥ä¸Šï¼Œè€Œå®¿ä¸»æœºçš„ç½‘æ¡¥ä¸å†ä¸å®¿ä¸»æœºçš„eth0ç­‰è®¾å¤‡è¿æ¥ï¼Œä»è€Œå®ç°éš”ç¦»çš„è™šæ‹Ÿç½‘ç»œ
- å› ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºåªèƒ½åœ¨å®¿ä¸»æœºäº’ç›¸é€šä¿¡ï¼Œè€Œä¸èƒ½è·¨å®¿ä¸»æœºè™šæ‹Ÿæœºä¸è™šæ‹Ÿæœºé—´é€šä¿¡ï¼Œæ‰€ä»¥ç”Ÿäº§ä¸­å¾ˆå°‘ä½¿ç”¨