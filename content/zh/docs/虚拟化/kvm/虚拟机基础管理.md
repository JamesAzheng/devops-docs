---
title: "虚拟机基础管理"
---

# 虚拟机管理工具总结

**QEMU guest agent**

- 来自 qemu-guest-agent 包，**须安装在虚拟机端**，而不是安装在宿主机端
- 安装在虚拟机中，相当于代理，可以**增加virsh命令对虚拟机的管理功能**
- 如果VM中安装QEMU guest agent，Host就可以使用libivrt向VM发送命令，例如"冻结"、"释放"文件系统，虚拟CPU的热添加及移除等。

**virt-manager**

- 来自 virt-manager 包
- 图形界面的虚拟机管理工具
- 主要功能：
  - 定义和创建虚拟机
  - 硬件管理
  - 性能监视
  - 控制台
  - 在线和离线迁移
  - 虚拟机的保存和关闭、启动、暂停、恢复等操作

**virsh**

- 来自 libvirt-client 包

- 命令行界面的虚拟机管理工具

**openssh-askpass**

- 来自 openssh-askpass 包，可以安装在任何Linux系统的主机上

- 可以实现对虚拟机的远程管理





# QEMU guest agent





# virt-manager

## 使用

- xshell6中需要开启Xmanager-passive程序

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```





# virsh

- 此工具基于 libvirtd 服务，此服务如果关闭或意外停止将无法继续使用virsh命令对虚拟机进行管理，**但虚拟机本身依旧会正常运行**
- **iptables规则 和 虚拟网卡等实现都是由 libvirtd服务生成的**

## 工作模式

### 交互式

```bash
# virsh #敲回车

# virsh 
Welcome to virsh, the virtualization interactive terminal.

Type:  'help' for help with commands #输入help即是帮助
       'quit' to quit
```

### 非交互式

```bash
# virsh list
...

#获取子命令帮助
# virsh help list
...
```

## 使用范例

可以使用虚拟机名称、编号、UUID来对虚拟机进行操作，但**UUID最保险**

- **只列出目前在运行的虚拟机**

```bash
virsh list
```

- **列出全部的虚拟机，包括停止运行的，还有虚拟机的ID编号**

```
virsh list --all
```

- **启动虚拟机**

```bash
virsh start centos7
```

- **正常关机（在virt-manager可以看到关机状态）**

```bash
virsh shutdown centos7
```

- **强制关机（在virt-manager可以看到关机状态）**

```bash
virsh destroy centos7
```

- **查看虚拟机的UUID**

```bash
virsh domuuid centos7
```

- **暂停虚拟机**

```bash
virsh suspend centos7
```

- **恢复暂停的虚拟机**

```bash
virsh resume centos7
```

- **实现虚拟机随宿主机开启自启动（在virt-manager图形界面也可以配置）**

```bash
# virsh autostart centos7-3 
Domain centos7-3 marked as autostarted

#本质上就是创建了软连接
[root@centos-kvm ~]# ll /etc/libvirt/qemu/autostart/
lrwxrwxrwx 1 root root 31 Apr  2 17:01 centos7-3.xml -> /etc/libvirt/qemu/centos7-3.xml
```

- **禁用虚拟机随宿主机开启自启动（在virt-manager图形界面也可以配置）**

```bash
# virsh autostart --disable centos7-3 
Domain centos7-3 unmarked as autostarted

#本质上就是删除了软连接
# ll /etc/libvirt/qemu/autostart/
total 0
```

- **查看虚拟机配置（所有虚拟机的配置文件都存放在 /etc/libvirt/qemu/ 目录下）**

```bash
virsh dumpxml centos7 #本质上就是查看/etc/libvirt/qemu/centos7.xml文件
```



## 高级功能

- 虚拟机中安装QEMU guest agent后

- 在安装 QEMU guest agent后，通过libvirt来使用QEMU guest agent，可以对libvirt命令有如下的加强

```bash
virsh domtime #获取虚拟机的时间
...
```







# openssh-askpass

- 可以实现远程管理虚拟机，即在一个没有虚拟机的宿主机上远程管理其他宿主机的虚拟机

## 范例

```bash
#在没有虚拟机的宿主机上安装
yum -y install openssh-askpass

#打开管理界面
yum -y install virt-manager qemu-kvm libvirt
export DISPLAY=10.0.0.1:0.0
virt-manager

#然后再界面增加连接，选择ssh连接后输入主机IP即可

#但是需要被管理的宿主机守护进程关闭
systemctl stop libvirtd
```









