---
title: "创建虚拟机"
---

# 准备安装系统所需的ISO文件

- 将需要安装的系统ISO文件上传到宿主机

```bash
[root@centos-kvm ~]# mkdir -p /data/isos/{centos/{7,8},ubuntu/{18.04,20.04}}

[root@centos-kvm ~]# tree /data/
/data/
└── isos
    ├── centos
    │   ├── 7
    │   └── 8
    └── ubuntu
        ├── 18.04
        └── 20.04


#拷贝光盘后
[root@centos-kvm ~]# tree /data/
/data/
└── isos
    ├── centos
    └── ubuntu
        └── ubuntu-20.04.4-live-server-amd64.iso
```



# 注意事项

- **创建虚拟磁盘文件时，注意文件及名称是否已经存，否则会覆盖原有文件**
- 每开启一个虚拟机，则会开启一个vnet开头的网卡

## AMD CPU 创建虚拟机时的故障以及排错

AMD CPU 使用virt-manager 或 virt-install 在创建虚拟机时可能会出错：qemu-kvm:error:failed to set MSR 0xe1 to 0x0

### 修复方法

```bash
。。。
```

## 创建虚拟机的相关配置

```bash
#模拟磁盘文件的路径
# ls -l /var/lib/libvirt/images/
total 21496768
-rw------- 1 qemu qemu 21478375424 Aug 10 17:09 centos8.qcow2

#虚拟机的配件文件路径
# ls -l /etc/libvirt/qemu
total 16
-rw------- 1 root root 5880 Aug 10 18:18 centos7.xml
-rw------- 1 root root 5878 Aug 10 17:02 centos8.xml
```







# 使用 virt-manager 创建

- virt-manager 是一个图形化虚拟机管理工具，方便管理和查看虚拟机，实现须在操作的主机上安装xmanager
- **此方式安装一个缺点：定义多大的存储空间就直接在磁盘上占用多大的空间**

## 开启图形界面

- xshell6中需要开启Xmanager-passive程序

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

## 创建虚拟机

...

## 总结

- 通过 virt-manager 创建虚拟机，整个过程都是手动操作，不便于生产中大规模批量创建







# 使用 virt-install 创建

- virt-install 可以实现基于命令行的方式创建虚拟机

## virt-install 命令说明

- 常用选项说明

```bash
# virt-install --help
usage: virt-install --name NAME --memory MB STORAGE INSTALL [options]

使用“--option=？”或“--option help”查看可用的子选项
有关示例和完整选项语法，请参见man page

--------------------------------------------------------------------------

#optional arguments:
-n NAME, --name NAME #指定创建虚拟机的名称

--memory MEMORY #给虚拟机分配的内存(默认以M为单位)如：--memory 1024 即表示分配1G内存

--vcpus VCPUS #为虚拟机分配的CPU数量，如：--vcpus 3 即表示分配三颗cpu核心

--cpu CPU #CPU型号和特点

--metadata METADATA #配置虚拟机元数据，如：--metadata description="My nice long description"

--------------------------------------------------------------------------


#Installation Method Options:
--cdrom CDROM #指定光盘为安装介质

-l LOCATION #指定安装源，如：
            #nfs://host/path
            #http://host/path
            #ftp://host/path

--pxe #使用pxe协议从网络启动pxe

--import #在磁盘映像中构建虚拟机

--boot BOOT #配置虚拟机引导设置，如：
            #--boot hd,cdrom,menu=on
            #--boot init=/sbin/init（用于容器）

--idmap IDMAP #为 LXC 容器启用用户名称空间，如：
              #--idmap uid.start=0,uid.target=1000,uid.count=10
              
--------------------------------------------------------------------------

#OS options:
--os-variant OS_VARIANT #指定安装的文件系统，如centos7、ubuntu20.04等，
                        #支持的系统列表 参阅：osinfo-query os 命令
                        
--------------------------------------------------------------------------                   
#Device Options:
--disk DISK  #使用不同的选项来指定存储，如：
             #--disk size=10 (new 10GiB image in default location)
             #--disk /my/existing/disk,cache=none
             #--disk device=cdrom,bus=scsi
             #--disk=?

-w NETWORK, --network NETWORK
                        Configure a guest network interface. Ex:
                        --network bridge=mybr0
                        --network network=my_libvirt_virtual_net
                        --network network=mynet,model=virtio,mac=00:11...
                        --network none
                        --network help
  --graphics GRAPHICS   Configure guest display settings. Ex:
                        --graphics spice
                        --graphics vnc,port=5901,listen=0.0.0.0
                        --graphics none
  --controller CONTROLLER
                        Configure a guest controller device. Ex:
                        --controller type=usb,model=qemu-xhci
                        --controller virtio-scsi
  --input INPUT         Configure a guest input device. Ex:
                        --input tablet
                        --input keyboard,bus=usb
  --serial SERIAL       Configure a guest serial device
  --parallel PARALLEL   Configure a guest parallel device
  --channel CHANNEL     Configure a guest communication channel
  --console CONSOLE     Configure a text console connection between the guest
                        and host
  --hostdev HOSTDEV     Configure physical USB/PCI/etc host devices to be
                        shared with the guest
  --filesystem FILESYSTEM
                        Pass host directory to the guest. Ex: 
                        --filesystem /my/source/dir,/dir/in/guest
                        --filesystem template_name,/,type=template
  --sound [SOUND]       Configure guest sound device emulation
  --watchdog WATCHDOG   Configure a guest watchdog device
  --video VIDEO         Configure guest video hardware.
  --smartcard SMARTCARD
                        Configure a guest smartcard device. Ex:
                        --smartcard mode=passthrough
  --redirdev REDIRDEV   Configure a guest redirection device. Ex:
                        --redirdev usb,type=tcp,server=192.168.1.1:4000
  --memballoon MEMBALLOON
                        Configure a guest memballoon device. Ex:
                        --memballoon model=virtio
  --tpm TPM             Configure a guest TPM device. Ex:
                        --tpm /dev/tpm
  --rng RNG             Configure a guest RNG device. Ex:
                        --rng /dev/urandom
  --panic PANIC         Configure a guest panic device. Ex:
                        --panic default
  --memdev MEMDEV       Configure a guest memory device. Ex:
                        --memdev dimm,target.size=1024
  --vsock VSOCK         Configure guest vsock sockets. Ex:
                        --vsock cid.auto=yes
                        --vsock cid.address=7

--------------------------------------------------------------------------

#Guest Configuration Options:
  --iothreads IOTHREADS
                        Set domain <iothreads> and <iothreadids>
                        configuration.
  --seclabel SECLABEL, --security SECLABEL
                        Set domain seclabel configuration.
  --cputune CPUTUNE     Tune CPU parameters for the domain process.
  --numatune NUMATUNE   Tune NUMA policy for the domain process.
  --memtune MEMTUNE     Tune memory policy for the domain process.
  --blkiotune BLKIOTUNE
                        Tune blkio policy for the domain process.
  --memorybacking MEMORYBACKING
                        Set memory backing policy for the domain process. Ex:
                        --memorybacking hugepages=on
  --features FEATURES   Set domain <features> XML. Ex:
                        --features acpi=off
                        --features apic=on,apic.eoi=on
  --clock CLOCK         Set domain <clock> XML. Ex:
                        --clock offset=localtime,rtc_tickpolicy=catchup
  --pm PM               Configure VM power management features
  --events EVENTS       Configure VM lifecycle management policy
  --resource RESOURCE   Configure VM resource partitioning (cgroups)
  --sysinfo SYSINFO     Configure SMBIOS System Information. Ex:
                        --sysinfo host
                        --sysinfo bios.vendor=MyVendor,bios.version=1.2.3,...
  --qemu-commandline QEMU_COMMANDLINE
                        Pass arguments directly to the qemu emulator. Ex:
                        --qemu-commandline='-display gtk,gl=on'
                        --qemu-commandline env=DISPLAY=:0.1
  --launchSecurity LAUNCHSECURITY, --launchsecurity LAUNCHSECURITY
                        Configure VM launch security (e.g. SEV memory encryption). Ex:
                        --launchSecurity type=sev,cbitpos=47,reducedPhysBits=1,policy=0x0001,dhCert=BASE64CERT
                        --launchSecurity sev

--------------------------------------------------------------------------

#Virtualization Platform Options:
  -v, --hvm             This guest should be a fully virtualized guest
  -p, --paravirt        This guest should be a paravirtualized guest
  --container           This guest should be a container guest

--virt-type VIRT_TYPE #指定虚拟机平台，如：kvm, qemu, xen, ...
                        
  --arch ARCH           The CPU architecture to simulate
  --machine MACHINE     The machine type to emulate

--------------------------------------------------------------------------

#Miscellaneous Options:
  --autostart           在主机启动时启动域自动启动
  --transient           Create a transient domain.
  --destroy-on-exit     Force power off the domain when the console viewer is
                        closed.
  --wait [WAIT]         Minutes to wait for install to complete.

-noautoconsole  #不要自动尝试连接到客户端控制台

  --noreboot            Don't boot guest after completing install.
  --print-xml [XMLONLY]
                        Print the generated domain XML rather than create the
                        guest.
  --dry-run             Run through install process, but do not create devices
                        or define the guest.
  --check CHECK         Enable or disable validation checks. Example:
                        --check path_in_use=off
                        --check all=off
  -q, --quiet           Suppress non-error output
  -d, --debug           Print debugging information

```

## virt-install 命令创建虚拟机

- **利用 qemu-img命令创建虚拟磁盘**
- *.qcow2 为镜像文件的格式，也是后缀

```bash
#创建一个名为centos8-kvm2.qcow2的虚拟磁盘文件，最大容量为30G
qemu-img create -f qcow2 /var/lib/libvirt/images/ubuntu20.04-kvm.qcow2 30G 

#创建完成后实际占用的空间并没有30G，即动态增长
# ls -lh /var/lib/libvirt/images/
total 196K
-rw-r--r-- 1 root root 193K Mar 28 18:53 ubuntu20.04-kvm.qcow2
```

- **使用virt-install 安装虚拟机**

```bash
#ubuntu20.04，创建默认NAT模式的虚拟机
virt-install --virt-type kvm --name ubuntu20.04 --memory 1024 --vcpus 2 --cdrom=/data/isos/ubuntu/ubuntu-20.04.4-live-server-amd64.iso --disk path=/var/lib/libvirt/images/ubuntu20.04-kvm.qcow2 --network network=default --noautoconsole --os-variant=ubuntu20.04

#centos7
virt-install --virt-type kvm --name centos7 --memory 1024 --vcpus 2 --cdrom=/data/isos/CentOS-7-x86_64-DVD-1810.iso --disk path=/var/lib/libvirt/images/centos7.qcow2 --network network=default --noautoconsole --os-variant=centos7
```

- **转到控制台查看并操作安装过程**

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

## 总结

- 通过 virt-install 创建虚拟机，虽然免去了之前 virt-manager 定义虚拟机基本参数的操作，但是**后续的过程还是基于手动操作来完成的**，所以同样不便于生产中大规模批量创建





# 使用 virt-install+kickstart 创建

## 前期准备

### 在宿主机部署nginx

```nginx
#安装
yum -y install nginx

# vim /etc/nginx/nginx.conf
#修改配置文件
...
http {
...
    include             /etc/nginx/mime.types;
    default_type        text/plain;
    charset utf-8;
...
server {
    listen 80 default_server;
    server_name _;
    root /mnt/;
    autoindex on;
    autoindex_localtime on;
}
...

#启动服务
systemctl enable --now nginx.service
```

### 创建相关目录

```bash
[root@centos-kvm ~]# mkdir -p /mnt/{ks,centos/{7,8}/os/x86_64/}
[root@centos-kvm ~]# tree /mnt/
/mnt/
├── centos
│   ├── 7
│   │   └── os
│   │       └── x86_64
│   └── 8
│       └── os
│           └── x86_64
└── ks
```

### 准备 kickstart 文件

#### centos7

```bash
# vim /data/ks/centos7-ks.cfg
#platform=x86, AMD64, or Intel EM64T
#version=DEVEL
# Install OS instead of upgrade
install
# Keyboard layouts
keyboard 'us'
# Root password
rootpw --iscrypted $1$qaFmIiHP$tTy.0GvmJlaDlFaXKkCSo/
# System language
lang en_US
# System authorization information
auth  --useshadow  --passalgo=sha512
# Use text mode install
text
firstboot --disable
# SELinux configuration
selinux --disabled
# Do not configure the X Window System
skipx


# Firewall configuration
firewall --disabled
# Network information
network  --bootproto=dhcp --device=eth0
# Reboot after installation
reboot
# System timezone
timezone Asia/Shanghai
# Use network installation
url --url="http://10.0.0.8/centos/7/os/x86_64/"
# System bootloader configuration
bootloader --location=mbr
# Clear the Master Boot Record
zerombr
# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot --fstype="ext4" --size=1024
part /data --fstype="ext4" --size=51200
part / --fstype="ext4" --size=51200

%packages
@^minimal
vim-enhanced
tcpdump
%end

%post
useradd azheng
mkdir /test
%end
```

#### centos8

```bash
# vim /data/ks/centos8-ks.cfg
#platform=x86, AMD64, or Intel EM64T
#version=DEVEL
# Keyboard layouts
keyboard 'us'
# Root password
rootpw --iscrypted $1$qaFmIiHP$tTy.0GvmJlaDlFaXKkCSo/
# System language
lang en_US
# System authorization information
authselect  --useshadow  --passalgo=sha512
# Use text mode install
text
firstboot --disable
# SELinux configuration
selinux --disabled
# Do not configure the X Window System
skipx


# Firewall configuration
firewall --disabled
# Network information
network  --bootproto=dhcp --device=eth0
# Reboot after installation
reboot
# System timezone
timezone Asia/Shanghai
# Use network installation
url --url="http://10.0.0.8/centos/8/os/x86_64/"
# System bootloader configuration
bootloader --location=mbr
# Clear the Master Boot Record
zerombr
# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot --fstype="ext4" --size=1024
part /data --fstype="ext4" --size=51200
part / --fstype="ext4" --size=51200

%packages
vim
tcpdump
%end

%post
useradd azheng
mkdir /test
%end
```

### 准备 yum 源

```bash
[root@centos-kvm ~]# mount /data/isos/centos/7/CentOS-7-x86_64-DVD-2009.iso /mnt/centos/7/os/x86_64/
```

## 方法一：配合 kickstart文件 实现半自动安装

- 下面以centos7安装作为演示

### 开启图形界面

- xshell6中需要开启Xmanager-passive程序

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

### 创建虚拟磁盘

```bash
#创建一个名为centos8-kvm2.qcow2的虚拟磁盘文件，最大容量为20G
qemu-img create -f qcow2 /var/lib/libvirt/images/centos7-kvm.qcow2 200G 

#创建完成后实际占用的空间并没有200G，即动态增长
# ls -lh /var/lib/libvirt/images/
total 196K
-rw-r--r-- 1 root root 196K Mar 31 20:57 centos7-kvm.qcow2
```

### 创建虚拟机

```bash
virt-install --virt-type kvm --name centos7 --memory 2048 --vcpus 2 --cdrom=/data/isos/centos/7/CentOS-7-x86_64-DVD-2009.iso --disk path=/var/lib/libvirt/images/centos7-kvm.qcow2 --network network=default --noautoconsole --os-variant=centos7.0
```

### 后续操作

- 需快速转到图形控制界面，然后执行下面的操作（因为默认超过60s 就自动安装了）
  - Install CentOS 7，然后按tab键，在最后输入以下内容：
    - ks=http://10.0.0.8/ks/centos7-ks.cfg



## 方法二：配合 kickstart文件 实现全自动安装

- **常用**

- 下面以centos7安装作为演示

### 开启图形界面

- xshell6中需要开启Xmanager-passive程序

```bash
#centos or Ubuntu
export DISPLAY=10.0.0.1:0.0

virt-manager
```

### 创建虚拟磁盘

```bash
#创建一个名为centos8-kvm2.qcow2的虚拟磁盘文件，最大容量为20G
qemu-img create -f qcow2 /var/lib/libvirt/images/centos7-kvm.qcow2 200G 

#创建完成后实际占用的空间并没有200G，即动态增长
# ls -lh /var/lib/libvirt/images/
total 196K
-rw-r--r-- 1 root root 196K Mar 31 20:57 centos7-kvm.qcow2
```

### 创建虚拟机

- 核心是以下两个选项：
  - --location=/data/isos/centos/7/CentOS-7-x86_64-DVD-2009.iso
  - --extra-args="ks=http://10.0.0.8/ks/centos7-ks.cfg"

```bash
virt-install --virt-type kvm --name centos7 --memory 2048 --vcpus 2 --location=/data/isos/centos/7/CentOS-7-x86_64-DVD-2009.iso --disk path=/var/lib/libvirt/images/centos7-kvm.qcow2 --network network=default --noautoconsole --os-variant=centos7.0 --extra-args="ks=http://10.0.0.8/ks/centos7-ks.cfg"
```

### 后续操作

- 可以转到图形控制界面查看安装过程，在此期间无需人工介入





# 使用 virt-install+ PXE创建

- PXE实现准备过程参阅 KVM pdf 或 OS install笔记
- **注意：ks文件的虚拟磁盘要改为vda**

```bash
#创建虚拟磁盘
qemu-img create -f qcow2 /var/lib/libvirt/images/centos7-pxe.qcow2 200G

#创建自定义网桥的虚拟机
virt-install --virt-type kvm --name centos7 --memory 2048 --vcpus 2 --disk bus=virtio,path=/var/lib/libvirt/images/centos7-pxe.qcow2 --graphics vnc,listen=0.0.0.0 --network=bridge:virbr1,model=virtio --pxe
```



# 基于现有虚拟机磁盘为模板创建新的虚拟机

## 注意事项

- 拷贝前要将占用虚拟机的磁盘文件的虚拟机关机



## 方法一：通过图形界面创建

- **先将虚拟机的磁盘文件拷贝一份**

```bash
cp /var/lib/libvirt/images/centos7-kvm.qcow2 /var/lib/libvirt/images/centos7-kvm2.qcow2
```

- **然后在virt-manager中新建虚拟机，选择基于磁盘文件创建，在选择新复制的虚拟机文件即可**

  - ```bash
    #centos or Ubuntu
    export DISPLAY=10.0.0.1:0.0
    
    virt-manager
    ```

  - File --> New virtual Machine --> Import existing disk image --> Forward --> 选择拷贝的文件并添加文件系统 选择CPU、内存等操作 --> Finish

```bash
#开启虚拟机后同时会自动生成虚拟机的配置文件（文件名称在虚拟机生成向导时指定）
[root@centos-kvm ~]# ll /etc/libvirt/qemu
total 24
-rw------- 1 root root 5671 Aug 10 19:17 centos7.0.xml
-rw------- 1 root root 5880 Aug 10 18:18 centos7.xml
```



## 方法二：通过命令行创建

- **先将虚拟机的磁盘文件拷贝一份**

```bash
cp /var/lib/libvirt/images/centos7-kvm.qcow2 /var/lib/libvirt/images/centos7-kvm3.qcow2
```

- **宿主机执行以下命令**

```bash
#核心命令：
#--disk  bus=virtio,path=/var/lib/libvirt/images/centos7-kvm3.qcow2
#--network network=default,model=virtio
#--boot hd
virt-install --virt-type kvm --name centos7-3 --memory 2048 --vcpus 2 --disk  bus=virtio,path=/var/lib/libvirt/images/centos7-kvm3.qcow2 --network network=default,model=virtio --noautoconsole --autostart --boot hd
```

- **运行工具，可以看到下面出现新的虚拟机**

```bash
#执行完毕后同时会自动生成虚拟机的配置文件（文件名称在虚拟机生成向导时指定）
[root@centos-kvm ~]# ll /etc/libvirt/qemu
total 20
drwxr-xr-x 2 root root   27 Mar 31 22:31 autostart
-rw------- 1 root root 5671 Mar 31 22:15 centos7.0.xml
-rw------- 1 root root 3878 Mar 31 22:31 centos7-3.xml #
-rw------- 1 root root 5884 Mar 31 21:34 centos7.xml
drwx------ 3 root root   42 Mar 28 15:56 networks
```

